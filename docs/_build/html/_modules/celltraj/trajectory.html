<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>celltraj.trajectory &mdash; celltraj 0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            celltraj
          </a>
              <div class="version">
                0.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html">celltraj</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../authors.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../history.html">History</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">celltraj</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">celltraj.trajectory</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for celltraj.trajectory</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">;</span> <span class="n">__metaclass__</span> <span class="o">=</span> <span class="nb">type</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">coo_matrix</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="c1">#matplotlib.use(&#39;TkAgg&#39;)</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pyemma.coordinates</span> <span class="k">as</span> <span class="nn">coor</span>
<span class="kn">import</span> <span class="nn">pyemma.coordinates.clustering</span> <span class="k">as</span> <span class="nn">clustering</span>
<span class="kn">import</span> <span class="nn">pyemma</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">transform</span> <span class="k">as</span> <span class="n">tf</span>
<span class="kn">from</span> <span class="nn">skimage.measure</span> <span class="kn">import</span> <span class="n">regionprops_table</span>
<span class="kn">import</span> <span class="nn">skimage.morphology</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">ndimage</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">csaps</span>
<span class="kn">import</span> <span class="nn">mahotas</span>
<span class="kn">import</span> <span class="nn">mahotas.labeled</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">pystackreg</span> <span class="kn">import</span> <span class="n">StackReg</span>
<span class="kn">import</span> <span class="nn">pyemma.coordinates</span> <span class="k">as</span> <span class="nn">coor</span>
<span class="kn">import</span> <span class="nn">numpy.matlib</span>
<span class="kn">import</span> <span class="nn">umap</span>
<span class="kn">import</span> <span class="nn">btrack</span>
<span class="kn">from</span> <span class="nn">btrack.constants</span> <span class="kn">import</span> <span class="n">BayesianUpdates</span>
<span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="kn">import</span> <span class="nn">utilities</span>
<span class="kn">import</span> <span class="nn">imageprep</span> <span class="k">as</span> <span class="nn">imprep</span>
<span class="kn">import</span> <span class="nn">features</span>


<div class="viewcode-block" id="Trajectory"><a class="viewcode-back" href="../../stubs/celltraj.trajectory.Trajectory.html#celltraj.trajectory.Trajectory">[docs]</a><span class="k">class</span> <span class="nc">Trajectory</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A toolset for single-cell trajectory modeling. See:</span>
<span class="sd">    </span>
<span class="sd">    Danger</span>
<span class="sd">    -------</span>
<span class="sd">    This code, currently, should be considered as an untested pre-release version</span>
<span class="sd">    </span>
<span class="sd">    Todo</span>
<span class="sd">    ----</span>
<span class="sd">    Refactor</span>
<span class="sd">        In general, this class&#39;s methods generally handle data by holding state in the object.</span>
<span class="sd">        The functions that update state with the result of a calculation, though, tend to update a lot of state on the way.</span>
<span class="sd">        The state being updated along the way is usually &quot;helper&quot; quantities.</span>
<span class="sd">        I think it would be prudent to refactor these in such a way that these are updated in as few places as possible --</span>
<span class="sd">        one example of this might be setting them as properties, and then updating the value in state as part of that</span>
<span class="sd">        accessor if necessary.</span>
<span class="sd">    References</span>
<span class="sd">    --------</span>
<span class="sd">    Jeremy Copperman, Sean M. Gross, Young Hwan Chang, Laura M. Heiser, and Daniel M. Zuckerman. </span>
<span class="sd">    Morphodynamical cell-state description via live-cell imaging trajectory embedding. </span>
<span class="sd">    Biorxiv 10.1101/2021.10.07.463498, 2021.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="Trajectory.__init__"><a class="viewcode-back" href="../../stubs/celltraj.trajectory.Trajectory.html#celltraj.trajectory.Trajectory.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">h5filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Work-in-progress init function. Set h5filename, and tries to read in metadata.</span>
<span class="sd">        Todo</span>
<span class="sd">        ----</span>
<span class="sd">        - Also, comment all of these here. Right now most of them have comments throughout the code.</span>
<span class="sd">        - Reorganize these attributes into some meaningful structure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">h5filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h5filename</span><span class="o">=</span><span class="n">h5filename</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">h5filename</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;loading </span><span class="si">{</span><span class="n">h5filename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">=</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">h5filename</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metadata_dict</span><span class="o">=</span><span class="n">utilities</span><span class="o">.</span><span class="n">recursively_load_dict_contents_from_group</span><span class="p">(</span> <span class="n">f</span><span class="p">,</span> <span class="s1">&#39;/metadata/&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">metadata_dict</span><span class="p">:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">metadata_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;error loading metadata from </span><span class="si">{</span><span class="n">h5filename</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">h5filename</span><span class="si">}</span><span class="s1"> does not exist&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h5filename</span><span class="o">=</span><span class="kc">None</span></div>

<div class="viewcode-block" id="Trajectory.load_from_h5"><a class="viewcode-back" href="../../source/celltraj.html#celltraj.trajectory.Trajectory.load_from_h5">[docs]</a>    <span class="k">def</span> <span class="nf">load_from_h5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read in records from h5 file path recursively.</span>

<span class="sd">        :param path: Base path in h5 file.</span>
<span class="sd">        :type path: str</span>
<span class="sd">        :returns: True if successful, False otherwise.</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h5filename</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;loading </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h5filename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">=</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h5filename</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">datadict</span><span class="o">=</span><span class="n">utilities</span><span class="o">.</span><span class="n">recursively_load_dict_contents_from_group</span><span class="p">(</span> <span class="n">f</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">datadict</span><span class="p">:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">datadict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;error loading metadata from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h5filename</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h5filename</span><span class="si">}</span><span class="s1"> does not exist&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Trajectory.save_to_h5"><a class="viewcode-back" href="../../source/celltraj.html#celltraj.trajectory.Trajectory.save_to_h5">[docs]</a>    <span class="k">def</span> <span class="nf">save_to_h5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">path</span><span class="p">,</span><span class="n">attribute_list</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save attributes from a text list to model h5 file, to path in h5 file, recursively.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path</span>
<span class="sd">            Base path in h5 file.</span>
<span class="sd">        attribute list</span>
<span class="sd">            List of strings of attributes to save</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if successful, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h5filename</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;saving attributes </span><span class="si">{</span><span class="n">attribute_list</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1"> in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h5filename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">=</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h5filename</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">attribute_name</span> <span class="ow">in</span> <span class="n">attribute_list</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">dic</span> <span class="o">=</span> <span class="p">{</span> <span class="n">attribute_name</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute_name</span><span class="p">)</span> <span class="p">}</span>
                        <span class="n">utilities</span><span class="o">.</span><span class="n">recursively_save_dict_contents_to_group</span><span class="p">(</span> <span class="n">f</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">dic</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;saved </span><span class="si">{</span><span class="n">attribute_name</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h5filename</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">dic</span> <span class="o">=</span> <span class="p">{</span> <span class="n">attribute_name</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute_name</span><span class="p">)</span> <span class="p">}</span>
                                <span class="n">dsetName</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}{</span><span class="n">attribute_name</span><span class="si">}</span><span class="s1">&#39;</span>
                                <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="n">dsetName</span><span class="p">]</span>
                                <span class="n">utilities</span><span class="o">.</span><span class="n">recursively_save_dict_contents_to_group</span><span class="p">(</span> <span class="n">f</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">dic</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;overwrote existing and saved </span><span class="si">{</span><span class="n">attribute_name</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h5filename</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;error saving </span><span class="si">{</span><span class="n">attribute_name</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h5filename</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;error saving </span><span class="si">{</span><span class="n">attribute_name</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h5filename</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h5filename</span><span class="si">}</span><span class="s1"> does not exist&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Trajectory.get_frames"><a class="viewcode-back" href="../../source/celltraj.html#celltraj.trajectory.Trajectory.get_frames">[docs]</a>    <span class="k">def</span> <span class="nf">get_frames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Look for images in /images/img_%d/image to get number of frames (nt), and count cells in /images/img_%d/mask, store as attributes numImages, maxFrame, ncells_total</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if successful, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;no h5filename attribute&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fileName</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">h5filename</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;mskchannel&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmaskchannel</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;multiple mask channels, must specify attribute mskchannel for single-cell labels&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">numFiles</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">numImages</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">frameList</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">nImage</span><span class="o">=</span><span class="mi">1</span>
        <span class="n">n_frame</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">ncells_total</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">ncells</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">while</span> <span class="n">nImage</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">nImage</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dataIn</span><span class="o">=</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="n">dsetName</span> <span class="o">=</span> <span class="s2">&quot;/images/img_</span><span class="si">%d</span><span class="s2">/image&quot;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_frame</span><span class="p">)</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">dsetName</span> <span class="ow">in</span> <span class="n">dataIn</span>
                <span class="k">if</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">nImage</span><span class="o">=</span><span class="n">nImage</span><span class="o">+</span><span class="mi">1</span>
                    <span class="n">dsetName_mask</span> <span class="o">=</span> <span class="s2">&quot;/images/img_</span><span class="si">%d</span><span class="s2">/mask&quot;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_frame</span><span class="p">)</span>
                    <span class="n">dset</span> <span class="o">=</span> <span class="n">dataIn</span><span class="p">[</span><span class="n">dsetName_mask</span><span class="p">]</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[:]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmaskchannels</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">mskchannel</span><span class="p">]</span>
                    <span class="n">label_table</span><span class="o">=</span><span class="n">regionprops_table</span><span class="p">(</span><span class="n">label</span><span class="p">,</span><span class="n">intensity_image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">properties</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">])</span>
                    <span class="n">ncells</span> <span class="o">=</span> <span class="n">label_table</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
                    <span class="n">ncells_total</span><span class="o">=</span><span class="n">ncells_total</span><span class="o">+</span><span class="n">ncells</span>
                <span class="n">dataIn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;no images in </span><span class="si">{</span><span class="n">fileName</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nImage</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">numImages</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numImages</span><span class="p">,</span><span class="n">nImage</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Frame &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">n_frame</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; has &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nImage</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; images and &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ncells</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; cells</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">n_frame</span><span class="o">=</span><span class="n">n_frame</span><span class="o">+</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numImages</span><span class="o">=</span><span class="n">numImages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxFrame</span><span class="o">=</span><span class="n">numImages</span><span class="o">.</span><span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncells_total</span><span class="o">=</span><span class="n">ncells_total</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Trajectory.get_image_shape"><a class="viewcode-back" href="../../source/celltraj.html#celltraj.trajectory.Trajectory.get_image_shape">[docs]</a>    <span class="k">def</span> <span class="nf">get_image_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n_frame</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get image ([nz,]nx,ny,nchannels) and mask dimensions ([nz,]nx,ny,nmaskchannels), and store as attributes [nz,]nx,ny,ndim,nchannels,nmaskchannels</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_frame</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if successful, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;no h5filename attribute&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fileName</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">h5filename</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dataIn</span><span class="o">=</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">dsetName</span> <span class="o">=</span> <span class="s2">&quot;/images/img_</span><span class="si">%d</span><span class="s2">/image&quot;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_frame</span><span class="p">)</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">dsetName</span> <span class="ow">in</span> <span class="n">dataIn</span>
            <span class="k">if</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">dset</span><span class="o">=</span><span class="n">dataIn</span><span class="p">[</span><span class="n">dsetName</span><span class="p">]</span>
                <span class="n">img</span><span class="o">=</span><span class="n">dset</span><span class="p">[:]</span>
                <span class="n">dsetName</span> <span class="o">=</span> <span class="s2">&quot;/images/img_</span><span class="si">%d</span><span class="s2">/mask&quot;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_frame</span><span class="p">)</span>
                <span class="n">dset</span><span class="o">=</span><span class="n">dataIn</span><span class="p">[</span><span class="n">dsetName</span><span class="p">]</span>
                <span class="n">msk</span><span class="o">=</span><span class="n">dset</span><span class="p">[:]</span>
            <span class="n">dataIn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;interpreting image as xyc&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="o">=</span><span class="s1">&#39;xy&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">image_shape</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nchannels</span><span class="o">=</span><span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="o">=</span><span class="mi">2</span>
                <span class="k">if</span> <span class="n">msk</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;interpreting mask as xy&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nmaskchannels</span><span class="o">=</span><span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;interpreting mask as xyc&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nmaskchannels</span><span class="o">=</span><span class="n">msk</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;interpreting image as xyc&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="o">=</span><span class="s1">&#39;xyc&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">image_shape</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nchannels</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="o">=</span><span class="mi">2</span>
                    <span class="k">if</span> <span class="n">msk</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;interpreting mask as xy&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">nmaskchannels</span><span class="o">=</span><span class="mi">0</span>
                    <span class="k">if</span> <span class="n">msk</span><span class="o">.</span><span class="n">ndim</span><span class="o">&gt;</span><span class="mi">3</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;interpreting mask as xyc&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">nmaskchannels</span><span class="o">=</span><span class="n">msk</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;interpreting image as zxy&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="o">=</span><span class="s1">&#39;zxy&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nz</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">image_shape</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">nz</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nchannels</span><span class="o">=</span><span class="mi">0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="o">=</span><span class="mi">3</span>
                    <span class="k">if</span> <span class="n">msk</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;interpreting mask as zxy&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">nmaskchannels</span><span class="o">=</span><span class="mi">0</span>
                    <span class="k">if</span> <span class="n">msk</span><span class="o">.</span><span class="n">ndim</span><span class="o">&gt;</span><span class="mi">3</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;interpreting mask as zxyc&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">nmaskchannels</span><span class="o">=</span><span class="n">msk</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;interpreting image as zxyc&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="o">=</span><span class="s1">&#39;zxyc&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nz</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">image_shape</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">nz</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nchannels</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="o">=</span><span class="mi">3</span>
                <span class="k">if</span> <span class="n">msk</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;interpreting mask as zxy&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nmaskchannels</span><span class="o">=</span><span class="mi">0</span>
                <span class="k">if</span> <span class="n">msk</span><span class="o">.</span><span class="n">ndim</span><span class="o">&gt;</span><span class="mi">3</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;interpreting mask as zxyc&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nmaskchannels</span><span class="o">=</span><span class="n">msk</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;error in </span><span class="si">{</span><span class="n">fileName</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Trajectory.get_image_data"><a class="viewcode-back" href="../../source/celltraj.html#celltraj.trajectory.Trajectory.get_image_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_image_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n_frame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get image data from a frame</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_frame</span>
<span class="sd">            frame number</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        img : ndarray</span>
<span class="sd">            image data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h5filename</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">dsetName</span> <span class="o">=</span> <span class="s2">&quot;/images/img_</span><span class="si">%d</span><span class="s2">/image&quot;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_frame</span><span class="p">)</span>
            <span class="n">dset</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="n">dsetName</span><span class="p">]</span>
            <span class="n">img</span><span class="o">=</span><span class="n">dset</span><span class="p">[:]</span>
        <span class="k">return</span> <span class="n">img</span></div>

<div class="viewcode-block" id="Trajectory.get_mask_data"><a class="viewcode-back" href="../../source/celltraj.html#celltraj.trajectory.Trajectory.get_mask_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_mask_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n_frame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get mask data from a frame</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_frame</span>
<span class="sd">            frame number</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        img : ndarray</span>
<span class="sd">            image data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h5filename</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">dsetName</span> <span class="o">=</span> <span class="s2">&quot;/images/img_</span><span class="si">%d</span><span class="s2">/mask&quot;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_frame</span><span class="p">)</span>
            <span class="n">dset</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="n">dsetName</span><span class="p">]</span>
            <span class="n">msk</span><span class="o">=</span><span class="n">dset</span><span class="p">[:]</span>
        <span class="k">return</span> <span class="n">msk</span></div>

<div class="viewcode-block" id="Trajectory.get_fmask_data"><a class="viewcode-back" href="../../source/celltraj.html#celltraj.trajectory.Trajectory.get_fmask_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_fmask_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n_frame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get foreground mask data for a frame, if self.fmskchannel is set will pull from mask data and be set from msk[...,fmskchannel]&gt;0 (or default mskchannel if self.fmskchannel not set), or if self.fmsk_threshold is set, will be thresholded from self.fmsk_imgchannel or first imgchannel.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_frame</span>
<span class="sd">            frame number</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fmsk : ndarray, bool</span>
<span class="sd">            foreground (cells) / background mask</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;fmskchannel&#39;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;getting foreground mask from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h5filename</span><span class="si">}</span><span class="s1"> mask channel </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fmskchannel</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">msk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_mask_data</span><span class="p">(</span><span class="n">n_frame</span><span class="p">)</span>
            <span class="n">fmsk</span><span class="o">=</span><span class="n">msk</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fmskchannel</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;fmsk_threshold&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;fmsk_imgchannel&#39;</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;need to set fmsk_imgchannel, image channel for thresholding&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;getting foreground mask from thresholded image data channel </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fmsk_imgchannel</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">img</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_image_data</span><span class="p">(</span><span class="n">n_frame</span><span class="p">)</span>
            <span class="n">img</span><span class="o">=</span><span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fmsk_imgchannel</span><span class="p">]</span>
            <span class="n">fmsk</span><span class="o">=</span><span class="n">img</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">fmsk_threshold</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;need to set attribute fmskchannel to pull from a mask channel or fmsk_threshold and fmsk_imgchannel to threshold an image channel for foreground masks&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fmsk</span></div>

<div class="viewcode-block" id="Trajectory.get_cell_blocks"><a class="viewcode-back" href="../../source/celltraj.html#celltraj.trajectory.Trajectory.get_cell_blocks">[docs]</a>    <span class="k">def</span> <span class="nf">get_cell_blocks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">label</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get min max indices for each cell in mask. Note the order of output here determines cell indexing. Will return skimage convention of label (msk) integers in increasing order, which is re-indexed from 0.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        msk</span>
<span class="sd">            label image of cells</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        cellblocks : ndarray</span>
<span class="sd">            Array of min max values for each cell, shape (label_max,image dim,2)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bbox_table</span><span class="o">=</span><span class="n">regionprops_table</span><span class="p">(</span><span class="n">label</span><span class="p">,</span><span class="n">intensity_image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">properties</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">,</span><span class="s1">&#39;bbox&#39;</span><span class="p">])</span>
        <span class="n">cblocks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">label</span><span class="p">),</span><span class="n">label</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">label</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">cblocks</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">bbox_table</span><span class="p">[</span><span class="s1">&#39;bbox-0&#39;</span><span class="p">]</span>
            <span class="n">cblocks</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">bbox_table</span><span class="p">[</span><span class="s1">&#39;bbox-1&#39;</span><span class="p">]</span>
            <span class="n">cblocks</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">bbox_table</span><span class="p">[</span><span class="s1">&#39;bbox-3&#39;</span><span class="p">]</span>
            <span class="n">cblocks</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">bbox_table</span><span class="p">[</span><span class="s1">&#39;bbox-4&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">label</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">cblocks</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">bbox_table</span><span class="p">[</span><span class="s1">&#39;bbox-0&#39;</span><span class="p">]</span>
            <span class="n">cblocks</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">bbox_table</span><span class="p">[</span><span class="s1">&#39;bbox-1&#39;</span><span class="p">]</span>
            <span class="n">cblocks</span><span class="p">[:,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">bbox_table</span><span class="p">[</span><span class="s1">&#39;bbox-2&#39;</span><span class="p">]</span>
            <span class="n">cblocks</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">bbox_table</span><span class="p">[</span><span class="s1">&#39;bbox-3&#39;</span><span class="p">]</span>
            <span class="n">cblocks</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">bbox_table</span><span class="p">[</span><span class="s1">&#39;bbox-4&#39;</span><span class="p">]</span>
            <span class="n">cblocks</span><span class="p">[:,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">bbox_table</span><span class="p">[</span><span class="s1">&#39;bbox-5&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">cblocks</span></div>

<div class="viewcode-block" id="Trajectory.get_cell_index"><a class="viewcode-back" href="../../source/celltraj.html#celltraj.trajectory.Trajectory.get_cell_index">[docs]</a>    <span class="k">def</span> <span class="nf">get_cell_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">save_h5</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get indices and host frame for each cell in image stack, and for each cell saves arrays of infor including frame index (cells_frameSet, cells_imgfileSet, cells_indimgSet, note these are named differently because of previous compatibility with running multiple image stacks in the same trajectory object, [ncells_total]), index value in trajectory object (cells_indSet, [ncells_total]), and bounding box in image (cellblocks [ncells_total, ndim, 2]</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True for success, False for error</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;nmaskchannels&#39;</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;no image shape set: first call get_image_shape or set axes and nt,nz,ny,nx,nmaskchannels attributes</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;ncells_total&#39;</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;set ncells_total attribute or run get_image_shape</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;mskchannel&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmaskchannel</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;multiple mask channels, must specify attribute mskchannel for single-cell labels&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;maxFrame&#39;</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;need number of frames, set maxFrame attribute</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">nImg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maxFrame</span>
        <span class="n">totalcells</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">ncells_total</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ncells_total</span>
        <span class="n">cells_imgfileSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncells_total</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">cells_indSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ncells_total</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">cells_indimgSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ncells_total</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">cellblocks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ncells_total</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">indcell_running</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nImg</span><span class="p">):</span>
            <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_mask_data</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmaskchannels</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">mskchannel</span><span class="p">]</span>
            <span class="n">cblocks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cell_blocks</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="n">ncells</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">cblocks</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">totalcells</span><span class="o">=</span><span class="n">totalcells</span><span class="o">+</span><span class="n">ncells</span>
            <span class="c1">#cells_imgfileSet=np.append(cells_imgfileSet,im*np.ones(ncells))</span>
            <span class="n">cells_imgfileSet</span><span class="p">[</span><span class="n">indcell_running</span><span class="p">:</span><span class="n">indcell_running</span><span class="o">+</span><span class="n">ncells</span><span class="p">]</span><span class="o">=</span><span class="n">im</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ncells</span><span class="p">)</span>
            <span class="c1">#cells_indSet=np.append(cells_indSet,np.arange(ncells).astype(int))</span>
            <span class="n">cells_indSet</span><span class="p">[</span><span class="n">indcell_running</span><span class="p">:</span><span class="n">indcell_running</span><span class="o">+</span><span class="n">ncells</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ncells</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="c1">#cellblocks=np.append(cellblocks,cblocks,axis=0)</span>
            <span class="n">cellblocks</span><span class="p">[</span><span class="n">indcell_running</span><span class="p">:</span><span class="n">indcell_running</span><span class="o">+</span><span class="n">ncells</span><span class="p">]</span><span class="o">=</span><span class="n">cblocks</span>
            <span class="n">indcell_running</span><span class="o">=</span><span class="n">indcell_running</span><span class="o">+</span><span class="n">ncells</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;frame &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">im</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; with &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ncells</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; cells</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cells_frameSet</span><span class="o">=</span><span class="n">cells_imgfileSet</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cells_imgfileSet</span><span class="o">=</span><span class="n">cells_imgfileSet</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cells_indSet</span><span class="o">=</span><span class="n">cells_indSet</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="o">=</span><span class="n">cells_imgfileSet</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cellblocks</span><span class="o">=</span><span class="n">cellblocks</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncells_total</span> <span class="o">!=</span> <span class="n">totalcells</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;expected </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ncells_total</span><span class="si">}</span><span class="s1"> cells but read </span><span class="si">{</span><span class="n">totalcells</span><span class="si">}</span><span class="s1"> cells&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">save_h5</span><span class="p">:</span>
            <span class="n">attribute_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cells_frameSet&#39;</span><span class="p">,</span><span class="s1">&#39;cells_imgfileSet&#39;</span><span class="p">,</span><span class="s1">&#39;cells_indSet&#39;</span><span class="p">,</span><span class="s1">&#39;cells_indimgSet&#39;</span><span class="p">,</span><span class="s1">&#39;cellblocks&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_to_h5</span><span class="p">(</span><span class="s1">&#39;/cell_data/&#39;</span><span class="p">,</span><span class="n">attribute_list</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Trajectory.get_cell_data"><a class="viewcode-back" href="../../source/celltraj.html#celltraj.trajectory.Trajectory.get_cell_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_cell_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ic</span><span class="p">,</span><span class="n">frametype</span><span class="o">=</span><span class="s1">&#39;boundingbox&#39;</span><span class="p">,</span><span class="n">boundary_expansion</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">return_masks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">relabel_masks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">relabel_mskchannels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">delete_background</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get image and mask data for a specific cell.</span>

<span class="sd">        Review options for pulling cell neighborhood data as well as the local cell data:</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ic : int</span>
<span class="sd">            cell ID.</span>
<span class="sd">        frametype : str</span>
<span class="sd">            Can be &#39;boundingbox&#39; for a bounding box of the cell label, &#39;neighborhood&#39; for the voronoi neighbors of the specified cell, or &#39;connected&#39; for the full set of connected cells.</span>
<span class="sd">        delete_background : bool</span>
<span class="sd">            Whether to set label and image pixels other than the single, neighborhood, or connected set to zero.</span>
<span class="sd">        return_masks : bool</span>
<span class="sd">            Whether to return mask data along with image data</span>
<span class="sd">        relabel_masks : bool</span>
<span class="sd">            Whether to relabel masks with movie cell indices</span>
<span class="sd">        relabel_mskchannels : array or list</span>
<span class="sd">            List of channels to relabel</span>
<span class="sd">        boundary_expansion : ndim ndarray, int</span>
<span class="sd">            Array to expand single-cell image in each direction</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        imgc : ndarray, float</span>
<span class="sd">            cell image data</span>
<span class="sd">        mskc : ndarray, int</span>
<span class="sd">            cell mask data, optional if return_masks=True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_frame</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span>
        <span class="n">ic_msk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indSet</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span> <span class="c1">#cell index in labeled image</span>
        <span class="n">img</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_image_data</span><span class="p">(</span><span class="n">n_frame</span><span class="p">)</span>
        <span class="n">msk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_mask_data</span><span class="p">(</span><span class="n">n_frame</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">frametype</span><span class="o">==</span><span class="s1">&#39;boundingbox&#39;</span><span class="p">:</span>
            <span class="n">indcells</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ic_msk</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1">#local indices of cells to return in the frame</span>
            <span class="n">cblock</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cellblocks</span><span class="p">[</span><span class="n">ic</span><span class="p">,</span><span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">boundary_expansion</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cblock</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">cblock</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">boundary_expansion</span>
                <span class="n">cblock</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="n">cblock</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
                <span class="n">cblock</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">cblock</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">boundary_expansion</span>
                <span class="n">indreplace</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cblock</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">image_shape</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">cblock</span><span class="p">[:,</span><span class="mi">1</span><span class="p">][</span><span class="n">indreplace</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">image_shape</span><span class="p">[</span><span class="n">indreplace</span><span class="p">]</span>
        <span class="n">indt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="o">==</span><span class="n">n_frame</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#all cells in frame</span>
        <span class="n">indcells_global</span><span class="o">=</span><span class="n">indt</span><span class="p">[</span><span class="n">indcells</span><span class="p">]</span> <span class="c1">#global indices of cells to return in movie</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">imgc</span><span class="o">=</span><span class="n">img</span><span class="p">[</span><span class="n">cblock</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]:</span><span class="n">cblock</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">cblock</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]:</span><span class="n">cblock</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">cblock</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]:</span><span class="n">cblock</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="o">...</span><span class="p">]</span>
            <span class="n">mskc</span><span class="o">=</span><span class="n">msk</span><span class="p">[</span><span class="n">cblock</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]:</span><span class="n">cblock</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">cblock</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]:</span><span class="n">cblock</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">cblock</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]:</span><span class="n">cblock</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="o">...</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">imgc</span><span class="o">=</span><span class="n">img</span><span class="p">[</span><span class="n">cblock</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]:</span><span class="n">cblock</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">cblock</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]:</span><span class="n">cblock</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="o">...</span><span class="p">]</span>
            <span class="n">mskc</span><span class="o">=</span><span class="n">msk</span><span class="p">[</span><span class="n">cblock</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]:</span><span class="n">cblock</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">cblock</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]:</span><span class="n">cblock</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="o">...</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">relabel_masks</span> <span class="ow">and</span> <span class="n">return_masks</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmaskchannels</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">relabel_mskchannels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">relabel_mskchannels</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mskchannel</span><span class="p">]</span>
                <span class="n">labelc</span> <span class="o">=</span> <span class="n">mskc</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">relabel_mskchannels</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">labelc</span> <span class="o">=</span> <span class="n">mskc</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
            <span class="n">label_table</span><span class="o">=</span><span class="n">regionprops_table</span><span class="p">(</span><span class="n">msk</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">mskchannel</span><span class="p">],</span><span class="n">intensity_image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">properties</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">])</span> <span class="c1">#table of labels for cells in frame</span>
            <span class="n">labelIDs</span><span class="o">=</span><span class="n">label_table</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">][</span><span class="n">indcells</span><span class="p">]</span> <span class="c1">#integer labels of cells in place</span>
            <span class="k">for</span> <span class="n">ichannel</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">relabel_mskchannels</span><span class="p">)):</span>
                <span class="n">label_table_channel</span><span class="o">=</span><span class="n">regionprops_table</span><span class="p">(</span><span class="n">msk</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">relabel_mskchannels</span><span class="p">[</span><span class="n">ichannel</span><span class="p">]],</span><span class="n">intensity_image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">properties</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">])</span> <span class="c1">#table of labels for cells in frame</span>
                <span class="n">labelIDs_channel</span><span class="o">=</span><span class="n">label_table_channel</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="c1">#integer labels of cells in place</span>
                <span class="n">labelIDs_common</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">labelIDs</span><span class="p">,</span><span class="n">labelIDs_channel</span><span class="p">)</span>
                <span class="n">mskc_channel</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">labelc</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">ichannel</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ic_relabel</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">labelIDs_common</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                    <span class="n">icell</span><span class="o">=</span><span class="n">labelIDs_common</span><span class="p">[</span><span class="n">ic_relabel</span><span class="p">]</span>
                    <span class="n">icell_global</span><span class="o">=</span><span class="n">indcells_global</span><span class="p">[</span><span class="n">ic_relabel</span><span class="p">]</span>
                    <span class="n">mskc_channel</span><span class="p">[</span><span class="n">labelc</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">ichannel</span><span class="p">]</span><span class="o">==</span><span class="n">icell</span><span class="p">]</span><span class="o">=</span><span class="n">icell_global</span>
                <span class="n">mskc</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">relabel_mskchannels</span><span class="p">[</span><span class="n">ichannel</span><span class="p">]]</span><span class="o">=</span><span class="n">mskc_channel</span>
        <span class="k">if</span> <span class="n">return_masks</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">imgc</span><span class="p">,</span> <span class="n">mskc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">imgc</span></div>
                
<div class="viewcode-block" id="Trajectory.get_cell_features"><a class="viewcode-back" href="../../source/celltraj.html#celltraj.trajectory.Trajectory.get_cell_features">[docs]</a>    <span class="k">def</span> <span class="nf">get_cell_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">function_tuple</span><span class="p">,</span><span class="n">indcells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">imgchannel</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">mskchannel</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">use_fmask_for_intensity_image</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">use_mask_for_intensity_image</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">bordersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">apply_contact_transform</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">return_feature_list</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">save_h5</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">concatenate_features</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get cell features using skimage&#39;s regionprops, passing a custom function tuple for measurement</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        function_tuple : single function or tuple of functions</span>
<span class="sd">            Function should take regionmask, intensity as input and output a scalar or array of features, compatible with skimage regionprops</span>
<span class="sd">        indcells : int ndarray</span>
<span class="sd">            array of cell indices from which to calculate features</span>
<span class="sd">        imgchannel : int</span>
<span class="sd">            channel for intensity image for feature calc</span>
<span class="sd">        mskchannel : int</span>
<span class="sd">            channel for single-cell labels for feature calc</span>
<span class="sd">        use_fmask_for_intensity_image : bool</span>
<span class="sd">            useful for environment featurization</span>
<span class="sd">        use_mask_for_intensity_image : bool</span>
<span class="sd">            whether to use get_mask_data rather than get_image_data for intensity image</span>
<span class="sd">        bordersize : int</span>
<span class="sd">            number of pixels to erode foreground mask if use_fmask_for_intensity_image is True, or the radius to grow contact boundaries if apply_contact_transform is True</span>
<span class="sd">        apply_contact_transform : bool</span>
<span class="sd">            whether to apply contact transform to get a mask of segmentation contacts from the mask channel if use_mask_for_intensity_image is True</span>
<span class="sd">        return_feature_list : bool</span>
<span class="sd">            whether to return an array of strings describing features calculated</span>
<span class="sd">        save_h5 : bool</span>
<span class="sd">            whether to save features to h5 file as /cell_data/Xf and descriptions as /cell_data/Xf_feature_list</span>
<span class="sd">        overwrite : bool</span>
<span class="sd">            whether to overwrite /cell_data/Xf and /cell_data/Xf_feature list in h5 file</span>
<span class="sd">        concatenate_features : bool</span>
<span class="sd">            whether to add features to existing Xf and Xf_feature_list</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Xf : ndarray (indcells.size,nfeatures)</span>
<span class="sd">            features indexed by cells_indSet</span>
<span class="sd">        feature_list : string array (nfeatures)</span>
<span class="sd">            description of cell features, optional</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">feature_postpend</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;msk</span><span class="si">{</span><span class="n">mskchannel</span><span class="si">}</span><span class="s1">img</span><span class="si">{</span><span class="n">imgchannel</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">use_fmask_for_intensity_image</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;using fmasks for intensity image&#39;</span><span class="p">)</span>
            <span class="n">feature_postpend</span><span class="o">=</span><span class="n">feature_postpend</span><span class="o">+</span><span class="s1">&#39;_fmsk&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">function_tuple</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="n">function_tuple</span><span class="o">=</span><span class="p">(</span><span class="n">function_tuple</span><span class="p">,)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;cells_indSet&#39;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;no cell index, run get_cell_index&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">indcells</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">indcells</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indSet</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">Xf</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">indcells</span><span class="p">)</span><span class="o">.</span><span class="n">size</span>
        <span class="n">ip_frame</span><span class="o">=</span><span class="mi">10000000</span>
        <span class="n">icell</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">icell</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">indcells</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="n">ic</span><span class="o">=</span><span class="n">indcells</span><span class="p">[</span><span class="n">icell</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_frameSet</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">==</span><span class="n">ip_frame</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;featurizing cells from frame &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_frameSet</span><span class="p">[</span><span class="n">ic</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">use_fmask_for_intensity_image</span><span class="p">:</span>
                    <span class="n">img</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_fmask_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">ic</span><span class="p">])</span> <span class="c1">#use foreground mask</span>
                    <span class="k">for</span> <span class="n">iborder</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bordersize</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                            <span class="n">img</span><span class="o">=</span><span class="n">skimage</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">binary_erosion</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">iz</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                                <span class="n">img</span><span class="p">[</span><span class="n">iz</span><span class="p">,</span><span class="o">...</span><span class="p">]</span><span class="o">=</span><span class="n">skimage</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">binary_erosion</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">iz</span><span class="p">,</span><span class="o">...</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">use_mask_for_intensity_image</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;using masks for intensity image&#39;</span><span class="p">)</span>
                    <span class="n">feature_postpend</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;msk</span><span class="si">{</span><span class="n">mskchannel</span><span class="si">}</span><span class="s1">msk</span><span class="si">{</span><span class="n">imgchannel</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="n">img</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_mask_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">ic</span><span class="p">])</span> <span class="c1">#use a mask for intensity image</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;using image for intensity image&#39;</span><span class="p">)</span>
                    <span class="n">img</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_image_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">ic</span><span class="p">])</span> <span class="c1">#use image data for intensity image</span>
                <span class="n">msk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_mask_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">ic</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;c&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">use_fmask_for_intensity_image</span><span class="p">:</span>
                    <span class="n">img</span><span class="o">=</span><span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">imgchannel</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmaskchannels</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">msk</span><span class="o">=</span><span class="n">msk</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">mskchannel</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">apply_contact_transform</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  applying contact transform&#39;</span><span class="p">)</span>
                    <span class="n">feature_postpend</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;msk</span><span class="si">{</span><span class="n">mskchannel</span><span class="si">}</span><span class="s1">cmsk</span><span class="si">{</span><span class="n">imgchannel</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                        <span class="n">img</span><span class="o">=</span><span class="n">features</span><span class="o">.</span><span class="n">get_contact_boundaries</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">radius</span><span class="o">=</span><span class="n">bordersize</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">iz</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                            <span class="n">img</span><span class="p">[</span><span class="n">iz</span><span class="p">,</span><span class="o">...</span><span class="p">]</span><span class="o">=</span><span class="n">features</span><span class="o">.</span><span class="n">get_contact_boundaries</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">iz</span><span class="p">,</span><span class="o">...</span><span class="p">],</span><span class="n">radius</span><span class="o">=</span><span class="n">bordersize</span><span class="p">)</span>
                <span class="n">props</span> <span class="o">=</span> <span class="n">regionprops_table</span><span class="p">(</span><span class="n">msk</span><span class="p">,</span> <span class="n">intensity_image</span><span class="o">=</span><span class="n">img</span><span class="p">,</span><span class="n">properties</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,),</span> <span class="n">extra_properties</span><span class="o">=</span><span class="n">function_tuple</span><span class="p">)</span>
                <span class="n">Xf_frame</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">props</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">props</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">Xf_frame</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">props</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">Xf</span><span class="p">[</span><span class="n">icell</span><span class="p">]</span><span class="o">=</span><span class="n">Xf_frame</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indSet</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">ip_frame</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_frameSet</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span>
        <span class="n">feature_list</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">Xf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">props</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">feature_list</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">key</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">feature_postpend</span>
        <span class="k">if</span> <span class="n">save_h5</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">concatenate_features</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;Xf&#39;</span><span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;must have loaded feature array to concatenate&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">return_feature_list</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Xf</span><span class="p">),</span> <span class="n">feature_list</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Xf</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">Xf_prev</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Xf</span>
                        <span class="n">Xf_feature_list_prev</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Xf_feature_list</span>
                        <span class="n">Xf</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Xf_prev</span><span class="p">,</span><span class="n">Xf</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">feature_list</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Xf_feature_list_prev</span><span class="p">,</span><span class="n">feature_list</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Xf</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Xf</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Xf_feature_list</span><span class="o">=</span><span class="n">feature_list</span>
                <span class="n">attribute_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Xf&#39;</span><span class="p">,</span><span class="s1">&#39;Xf_feature_list&#39;</span><span class="p">]</span>
                <span class="n">data_written</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_to_h5</span><span class="p">(</span><span class="s1">&#39;/cell_data/&#39;</span><span class="p">,</span><span class="n">attribute_list</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;error writing data, </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_feature_list</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Xf</span><span class="p">),</span> <span class="n">feature_list</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Xf</span><span class="p">)</span></div>

<div class="viewcode-block" id="Trajectory.get_cell_compartment_ratio"><a class="viewcode-back" href="../../source/celltraj.html#celltraj.trajectory.Trajectory.get_cell_compartment_ratio">[docs]</a>    <span class="k">def</span> <span class="nf">get_cell_compartment_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">indcells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">imgchannel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">mskchannel1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">mskchannel2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">make_disjoint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">erosion_footprint1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">erosion_footprint2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">combined_and_disjoint</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">intensity_sum</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">intensity_ztransform</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">inverse_ratio</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">save_h5</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get cell features using skimage&#39;s regionprops, passing a custom function tuple for measurement</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        indcells : int ndarray</span>
<span class="sd">            array of cell indices from which to calculate features</span>
<span class="sd">        imgchannel : int</span>
<span class="sd">            channel for intensity image for feature calc</span>
<span class="sd">        mskchannel1 : int</span>
<span class="sd">            first channel for single-cell labels for intensity calc, the numerator in ratio</span>
<span class="sd">        mskchannel2 : int</span>
<span class="sd">            second channel for single-cell labels for intensity calc, the denominator in ratio. Overlap with mskchannel1 will be removed</span>
<span class="sd">        combined_and_disjoint : bool</span>
<span class="sd">            combine masks 1 and 2, then dilate mask 2, erode mask 1, then remove mask 1 from mask 2</span>
<span class="sd">        erosion_footprint[12] : ndarray</span>
<span class="sd">            footprint of binary erosions to perform for each mask channel</span>
<span class="sd">        inverse_ratio : bool</span>
<span class="sd">            whether to take inverse (e.g. switch to c/n from n/c)</span>
<span class="sd">        save_h5 : bool</span>
<span class="sd">            whether to save features to h5 file as /cell_data/Xf and descriptions as /cell_data/Xf_feature_list</span>
<span class="sd">        overwrite : bool</span>
<span class="sd">            whether to overwrite /cell_data/Xf and /cell_data/Xf_feature list in h5 file</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        cratio : ndarray (indcells.size)</span>
<span class="sd">            compartment intensity ratio</span>
<span class="sd">        feature_list : string array (nfeatures)</span>
<span class="sd">            description of cell features, optional</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">imgchannel</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">mskchannel1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">mskchannel2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;set imgchannel, mskchannel1, and mskchannel2 keys&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;cells_indSet&#39;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;no cell index, run get_cell_index&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">indcells</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">indcells</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indSet</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">feature_name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;img</span><span class="si">{</span><span class="n">imgchannel</span><span class="si">}</span><span class="s1">_m</span><span class="si">{</span><span class="n">mskchannel1</span><span class="si">}</span><span class="s1">m</span><span class="si">{</span><span class="n">mskchannel2</span><span class="si">}</span><span class="s1">_ratio&#39;</span>
        <span class="n">cratio</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">indcells</span><span class="p">)</span><span class="o">.</span><span class="n">size</span>
        <span class="n">ip_frame</span><span class="o">=</span><span class="mi">10000000</span>
        <span class="n">icell</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">icell</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">indcells</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="n">ic</span><span class="o">=</span><span class="n">indcells</span><span class="p">[</span><span class="n">icell</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_frameSet</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">==</span><span class="n">ip_frame</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;featurizing cells from frame &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_frameSet</span><span class="p">[</span><span class="n">ic</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">img</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_image_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">ic</span><span class="p">])</span> <span class="c1">#use image data for intensity image</span>
                <span class="n">msk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_mask_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">ic</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;c&#39;</span><span class="p">:</span>
                    <span class="n">img</span><span class="o">=</span><span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">imgchannel</span><span class="p">]</span>
                <span class="n">msk1</span><span class="o">=</span><span class="n">msk</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">mskchannel1</span><span class="p">]</span>
                <span class="n">msk2</span><span class="o">=</span><span class="n">msk</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">mskchannel2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">combined_and_disjoint</span><span class="p">:</span>
                    <span class="n">msk2</span><span class="o">=</span><span class="n">imprep</span><span class="o">.</span><span class="n">get_cyto_minus_nuc_labels</span><span class="p">(</span><span class="n">msk1</span><span class="p">,</span><span class="n">msk2</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">make_disjoint</span><span class="p">:</span>
                    <span class="n">msk1</span><span class="p">[</span><span class="n">msk2</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">msk1</span><span class="p">)</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">msk2</span><span class="p">)):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;warning: frame </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="si">}</span><span class="s1"> mask1 and mask2 yielding different indices&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">erosion_footprint1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">fmsk1</span><span class="o">=</span><span class="n">skimage</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">binary_erosion</span><span class="p">(</span><span class="n">msk1</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="n">footprint</span><span class="o">=</span><span class="n">erosion_footprint1</span><span class="p">);</span> <span class="n">msk1</span><span class="p">[</span><span class="n">fmsk1</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
                <span class="k">if</span> <span class="n">erosion_footprint2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">fmsk2</span><span class="o">=</span><span class="n">skimage</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">binary_erosion</span><span class="p">(</span><span class="n">msk2</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="n">footprint</span><span class="o">=</span><span class="n">erosion_footprint2</span><span class="p">);</span> <span class="n">msk2</span><span class="p">[</span><span class="n">fmsk2</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
                <span class="n">props1</span> <span class="o">=</span> <span class="n">regionprops_table</span><span class="p">(</span><span class="n">msk1</span><span class="p">,</span> <span class="n">intensity_image</span><span class="o">=</span><span class="n">img</span><span class="p">,</span><span class="n">properties</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,</span><span class="s1">&#39;intensity_mean&#39;</span><span class="p">,</span><span class="s1">&#39;area&#39;</span><span class="p">))</span>
                <span class="n">props2</span> <span class="o">=</span> <span class="n">regionprops_table</span><span class="p">(</span><span class="n">msk2</span><span class="p">,</span> <span class="n">intensity_image</span><span class="o">=</span><span class="n">img</span><span class="p">,</span><span class="n">properties</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,</span><span class="s1">&#39;intensity_mean&#39;</span><span class="p">,</span><span class="s1">&#39;area&#39;</span><span class="p">))</span>
                <span class="n">commonlabels</span><span class="p">,</span><span class="n">indcommon1</span><span class="p">,</span><span class="n">indcommon2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">props1</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">],</span><span class="n">props2</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">],</span><span class="n">return_indices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">props2_matched</span><span class="o">=</span><span class="n">props1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">props2_matched</span><span class="p">[</span><span class="s1">&#39;intensity_mean&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">props1</span><span class="p">[</span><span class="s1">&#39;intensity_mean&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">props2_matched</span><span class="p">[</span><span class="s1">&#39;intensity_mean&#39;</span><span class="p">][</span><span class="n">indcommon1</span><span class="p">]</span><span class="o">=</span><span class="n">props2</span><span class="p">[</span><span class="s1">&#39;intensity_mean&#39;</span><span class="p">][</span><span class="n">indcommon2</span><span class="p">]</span>
                <span class="n">props2_matched</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">props1</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">props2_matched</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">][</span><span class="n">indcommon1</span><span class="p">]</span><span class="o">=</span><span class="n">props2</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">][</span><span class="n">indcommon2</span><span class="p">]</span>
                <span class="n">props2</span><span class="o">=</span><span class="n">props2_matched</span>
                <span class="k">if</span> <span class="n">intensity_sum</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">intensity_ztransform</span><span class="p">:</span>
                        <span class="n">cratio_frame</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_zstds</span><span class="p">[</span><span class="n">imgchannel</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">props1</span><span class="p">[</span><span class="s1">&#39;intensity_mean&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">img_zmeans</span><span class="p">[</span><span class="n">imgchannel</span><span class="p">],</span><span class="n">props1</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]),</span><span class="bp">self</span><span class="o">.</span><span class="n">img_zstds</span><span class="p">[</span><span class="n">imgchannel</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">props2</span><span class="p">[</span><span class="s1">&#39;intensity_mean&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">img_zmeans</span><span class="p">[</span><span class="n">imgchannel</span><span class="p">],</span><span class="n">props2</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cratio_frame</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">props1</span><span class="p">[</span><span class="s1">&#39;intensity_mean&#39;</span><span class="p">],</span><span class="n">props1</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">props2</span><span class="p">[</span><span class="s1">&#39;intensity_mean&#39;</span><span class="p">],</span><span class="n">props2</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">intensity_ztransform</span><span class="p">:</span>
                        <span class="n">cratio_frame</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_zstds</span><span class="p">[</span><span class="n">imgchannel</span><span class="p">]</span><span class="o">*</span><span class="n">props1</span><span class="p">[</span><span class="s1">&#39;intensity_mean&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">img_zmeans</span><span class="p">[</span><span class="n">imgchannel</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">img_zstds</span><span class="p">[</span><span class="n">imgchannel</span><span class="p">]</span><span class="o">*</span><span class="n">props2</span><span class="p">[</span><span class="s1">&#39;intensity_mean&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">img_zmeans</span><span class="p">[</span><span class="n">imgchannel</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cratio_frame</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">props1</span><span class="p">[</span><span class="s1">&#39;intensity_mean&#39;</span><span class="p">],</span><span class="n">props2</span><span class="p">[</span><span class="s1">&#39;intensity_mean&#39;</span><span class="p">])</span>
            <span class="n">cratio</span><span class="p">[</span><span class="n">icell</span><span class="p">]</span><span class="o">=</span><span class="n">cratio_frame</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indSet</span><span class="p">[</span><span class="n">ic</span><span class="p">]]</span>
            <span class="n">ip_frame</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_frameSet</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">inverse_ratio</span><span class="p">:</span>
            <span class="n">cratio</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">cratio</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">save_h5</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">feature_name</span><span class="p">,</span><span class="n">cratio</span><span class="p">)</span>
            <span class="n">attribute_list</span><span class="o">=</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_to_h5</span><span class="p">(</span><span class="s1">&#39;/cell_data/&#39;</span><span class="p">,</span><span class="n">attribute_list</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cratio</span><span class="p">)</span></div>

<div class="viewcode-block" id="Trajectory.get_cell_channel_crosscorr"><a class="viewcode-back" href="../../source/celltraj.html#celltraj.trajectory.Trajectory.get_cell_channel_crosscorr">[docs]</a>    <span class="k">def</span> <span class="nf">get_cell_channel_crosscorr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">indcells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">mskchannel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">imgchannel1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">imgchannel2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">save_h5</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get cross correlation between channels within cell labels</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        indcells : int ndarray</span>
<span class="sd">            array of cell indices from which to calculate features</span>
<span class="sd">        mskchannel : int</span>
<span class="sd">            channel for cell labels</span>
<span class="sd">        imgchannel1 : int</span>
<span class="sd">            first channel for correlation analysis</span>
<span class="sd">        mskchannel2 : int</span>
<span class="sd">            second channel for correlation analysis</span>
<span class="sd">        save_h5 : bool</span>
<span class="sd">            whether to save features to h5 file as /cell_data/Xf and descriptions as /cell_data/Xf_feature_list</span>
<span class="sd">        overwrite : bool</span>
<span class="sd">            whether to overwrite /cell_data/Xf and /cell_data/Xf_feature list in h5 file</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        corrc : ndarray (indcells.size)</span>
<span class="sd">            channel cross-correlation</span>
<span class="sd">        feature_list : string array (nfeatures)</span>
<span class="sd">            description of cell features, optional</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mskchannel</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">imgchannel1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">imgchannel2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;set imgchannel, mskchannel1, and mskchannel2 keys&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;cells_indSet&#39;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;no cell index, run get_cell_index&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">indcells</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">indcells</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indSet</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">feature_name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;m</span><span class="si">{</span><span class="n">mskchannel</span><span class="si">}</span><span class="s1">_img</span><span class="si">{</span><span class="n">imgchannel1</span><span class="si">}</span><span class="s1">img</span><span class="si">{</span><span class="n">imgchannel2</span><span class="si">}</span><span class="s1">_crosscorr&#39;</span>
        <span class="n">corrc</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">indcells</span><span class="p">)</span><span class="o">.</span><span class="n">size</span>
        <span class="n">ip_frame</span><span class="o">=</span><span class="mi">10000000</span>
        <span class="n">icell</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">icell</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">indcells</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="n">ic</span><span class="o">=</span><span class="n">indcells</span><span class="p">[</span><span class="n">icell</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_frameSet</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">==</span><span class="n">ip_frame</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;featurizing cells from frame &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_frameSet</span><span class="p">[</span><span class="n">ic</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">img</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_image_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">ic</span><span class="p">])</span> <span class="c1">#use image data for intensity image</span>
                <span class="n">msk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_mask_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">ic</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;c&#39;</span><span class="p">:</span>
                    <span class="n">msk</span><span class="o">=</span><span class="n">msk</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">mskchannel</span><span class="p">]</span>
                <span class="n">img1</span><span class="o">=</span><span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">imgchannel1</span><span class="p">]</span>
                <span class="n">img2</span><span class="o">=</span><span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">imgchannel2</span><span class="p">]</span>
                <span class="n">props1</span> <span class="o">=</span> <span class="n">regionprops_table</span><span class="p">(</span><span class="n">msk</span><span class="p">,</span> <span class="n">intensity_image</span><span class="o">=</span><span class="n">img1</span><span class="p">,</span><span class="n">properties</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,</span><span class="s1">&#39;image&#39;</span><span class="p">,</span><span class="s1">&#39;image_intensity&#39;</span><span class="p">))</span>
                <span class="n">props2</span> <span class="o">=</span> <span class="n">regionprops_table</span><span class="p">(</span><span class="n">msk</span><span class="p">,</span> <span class="n">intensity_image</span><span class="o">=</span><span class="n">img2</span><span class="p">,</span><span class="n">properties</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,</span><span class="s1">&#39;image&#39;</span><span class="p">,</span><span class="s1">&#39;image_intensity&#39;</span><span class="p">))</span>
                <span class="n">ncells_frame</span><span class="o">=</span><span class="n">props1</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
                <span class="n">corrc_frame</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ncells_frame</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">icell_frame</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncells_frame</span><span class="p">):</span>
                    <span class="n">corrc_frame</span><span class="p">[</span><span class="n">icell_frame</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">props1</span><span class="p">[</span><span class="s1">&#39;image_intensity&#39;</span><span class="p">][</span><span class="n">icell_frame</span><span class="p">][</span><span class="n">props1</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">][</span><span class="n">icell_frame</span><span class="p">]]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="n">props2</span><span class="p">[</span><span class="s1">&#39;image_intensity&#39;</span><span class="p">][</span><span class="n">icell_frame</span><span class="p">][</span><span class="n">props2</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">][</span><span class="n">icell_frame</span><span class="p">]]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">corrc</span><span class="p">[</span><span class="n">icell</span><span class="p">]</span><span class="o">=</span><span class="n">corrc_frame</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indSet</span><span class="p">[</span><span class="n">ic</span><span class="p">]]</span>
            <span class="n">ip_frame</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_frameSet</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">save_h5</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">feature_name</span><span class="p">,</span><span class="n">corrc</span><span class="p">)</span>
            <span class="n">attribute_list</span><span class="o">=</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_to_h5</span><span class="p">(</span><span class="s1">&#39;/cell_data/&#39;</span><span class="p">,</span><span class="n">attribute_list</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">corrc</span><span class="p">)</span></div>

<div class="viewcode-block" id="Trajectory.get_stack_trans"><a class="viewcode-back" href="../../source/celltraj.html#celltraj.trajectory.Trajectory.get_stack_trans">[docs]</a>    <span class="k">def</span> <span class="nf">get_stack_trans</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mskchannel</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">ntrans</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">maxt</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">dist_function</span><span class="o">=</span><span class="n">utilities</span><span class="o">.</span><span class="n">get_pairwise_distance_sum</span><span class="p">,</span><span class="n">zscale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">save_h5</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">do_global</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="o">**</span><span class="n">dist_function_keys</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get translations over image stack using a brute force function optimization approach.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mskchannel : mask channel for labels from which to obtain cell centers</span>
<span class="sd">            Function should take regionmask, intensity as input and output a scalar or array of features, compatible with skimage regionprops</span>
<span class="sd">        ntrans : int or int ndarray</span>
<span class="sd">            number of translations to try in each dimension</span>
<span class="sd">        maxt : float or float ndarray</span>
<span class="sd">            max translation in each dimension</span>
<span class="sd">        dist_function : function</span>
<span class="sd">            function to use for optimization. Should take centers0,centers1,tshift as input, and yield a score (lower is better)</span>
<span class="sd">        save_h5 : bool</span>
<span class="sd">            whether to save transformation matrices to h5 file as /cell_data/tf_matrix_set</span>
<span class="sd">        overwrite : bool</span>
<span class="sd">            whether to overwrite existing data in h5 file</span>
<span class="sd">        do_global : bool</span>
<span class="sd">            whether to do a global alignment matching center of all masks prior to brute force grid search</span>
<span class="sd">        dist_function_keys : keywords</span>
<span class="sd">            will be passed to dist_function for optimization</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tf_matrix_set : ndarray (nframes,ndim+1,ndim+1)</span>
<span class="sd">            array of aligning global transformations between frames</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nframes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nt</span>
        <span class="n">tSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nframes</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">msk0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_mask_data</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmaskchannels</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">msk0</span><span class="o">=</span><span class="n">msk0</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">mskchannel</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">iS</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nframes</span><span class="p">):</span>
            <span class="n">msk1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_mask_data</span><span class="p">(</span><span class="n">iS</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmaskchannels</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">msk1</span><span class="o">=</span><span class="n">msk1</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">mskchannel</span><span class="p">]</span>
            <span class="n">centers0</span><span class="o">=</span><span class="n">utilities</span><span class="o">.</span><span class="n">get_cell_centers</span><span class="p">(</span><span class="n">msk0</span><span class="p">)</span>
            <span class="n">centers1</span><span class="o">=</span><span class="n">utilities</span><span class="o">.</span><span class="n">get_cell_centers</span><span class="p">(</span><span class="n">msk1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">zscale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">centers0</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">zscale</span><span class="o">*</span><span class="n">centers0</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">centers1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">zscale</span><span class="o">*</span><span class="n">centers1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1">#translate centers1 com to centers0 com</span>
            <span class="k">if</span> <span class="n">do_global</span><span class="p">:</span>
                <span class="n">dcom</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">centers0</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">centers1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">centers1</span><span class="o">=</span><span class="n">centers1</span><span class="o">-</span><span class="n">dcom</span>
                <span class="n">clusters0</span><span class="o">=</span><span class="n">coor</span><span class="o">.</span><span class="n">clustering</span><span class="o">.</span><span class="n">AssignCenters</span><span class="p">(</span><span class="n">centers0</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">)</span>
                <span class="n">ind0to1</span><span class="o">=</span><span class="n">clusters0</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">centers1</span><span class="p">)</span>
                <span class="n">centers0_com</span><span class="o">=</span><span class="n">centers0</span><span class="p">[</span><span class="n">ind0to1</span><span class="p">,:]</span>
                <span class="n">dglobal</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">centers0_com</span><span class="o">-</span><span class="n">centers1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">centers1</span><span class="o">=</span><span class="n">centers1</span><span class="o">+</span><span class="n">dglobal</span>
                <span class="n">ind0to1g</span><span class="o">=</span><span class="n">clusters0</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">centers1</span><span class="p">)</span>
                <span class="n">centers0_global</span><span class="o">=</span><span class="n">centers0</span><span class="p">[</span><span class="n">ind0to1g</span><span class="p">,:]</span>
                <span class="c1">#tform = tf.estimate_transform(&#39;similarity&#39;, centers1, centers0_global)</span>
                <span class="n">t_global</span><span class="o">=-</span><span class="n">dcom</span><span class="o">+</span><span class="n">dglobal</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">t_global</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>
            <span class="n">t_local</span><span class="o">=</span><span class="n">utilities</span><span class="o">.</span><span class="n">get_tshift</span><span class="p">(</span><span class="n">centers0</span><span class="p">,</span><span class="n">centers1</span><span class="o">+</span><span class="n">t_global</span><span class="p">,</span><span class="n">dist_function</span><span class="p">,</span><span class="n">ntrans</span><span class="o">=</span><span class="n">ntrans</span><span class="p">,</span><span class="n">maxt</span><span class="o">=</span><span class="n">maxt</span><span class="p">,</span><span class="o">**</span><span class="n">dist_function_keys</span><span class="p">)</span>
            <span class="c1">#t_local=self.get_minT(msk0,msk1,nt=self.ntrans,dt=self.maxtrans)</span>
            <span class="n">tSet</span><span class="p">[</span><span class="n">iS</span><span class="p">,:]</span><span class="o">=</span><span class="n">t_global</span><span class="o">+</span><span class="n">t_local</span>
            <span class="k">if</span> <span class="n">zscale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tSet</span><span class="p">[</span><span class="n">iS</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">tSet</span><span class="p">[</span><span class="n">iS</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">zscale</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;frame </span><span class="si">{</span><span class="n">iS</span><span class="si">}</span><span class="s1"> translation </span><span class="si">{</span><span class="n">t_global</span><span class="o">+</span><span class="n">t_local</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">msk0</span><span class="o">=</span><span class="n">msk1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">tSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">tSet</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">tf_matrix_set</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nframes</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">iS</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nframes</span><span class="p">):</span>
            <span class="n">tf_matrix_set</span><span class="p">[</span><span class="n">iS</span><span class="p">,:,:]</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">EuclideanTransform</span><span class="p">(</span><span class="n">translation</span><span class="o">=</span><span class="n">tSet</span><span class="p">[</span><span class="n">iS</span><span class="p">,:],</span><span class="n">dimensionality</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span><span class="o">.</span><span class="n">params</span>
        <span class="k">if</span> <span class="n">save_h5</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tf_matrix_set</span><span class="o">=</span><span class="n">tf_matrix_set</span>
            <span class="n">attribute_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;tf_matrix_set&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_to_h5</span><span class="p">(</span><span class="s1">&#39;/cell_data/&#39;</span><span class="p">,</span><span class="n">attribute_list</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tf_matrix_set</span></div>

<div class="viewcode-block" id="Trajectory.get_cell_positions"><a class="viewcode-back" href="../../source/celltraj.html#celltraj.trajectory.Trajectory.get_cell_positions">[docs]</a>    <span class="k">def</span> <span class="nf">get_cell_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mskchannel</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">save_h5</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mskchannel</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mskchannel</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;getting positions from mask channel </span><span class="si">{</span><span class="n">mskchannel</span><span class="si">}</span><span class="s1">, default mskchannel is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mskchannel</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;tf_matrix_set&#39;</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;stack has not been trans registered: first call get_stack_trans() to set tf_matrix_set</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="n">tSet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tf_matrix_set</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ncells</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indSet</span><span class="o">.</span><span class="n">size</span>
        <span class="n">cells_positionSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ncells</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">))</span>
        <span class="n">cells_x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ncells</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nt</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;loading cells from frame &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">im</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">indc_img</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="o">==</span><span class="n">im</span><span class="p">)</span>
            <span class="n">msk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_mask_data</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmaskchannels</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">msk</span><span class="o">=</span><span class="n">msk</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">mskchannel</span><span class="p">]</span>
            <span class="n">centers</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ndimage</span><span class="o">.</span><span class="n">center_of_mass</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">msk</span><span class="p">),</span><span class="n">labels</span><span class="o">=</span><span class="n">msk</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">msk</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)))</span>
            <span class="n">cells_positionSet</span><span class="p">[</span><span class="n">indc_img</span><span class="p">,:]</span><span class="o">=</span><span class="n">centers</span>
            <span class="c1">#centers[:,0]=centers[:,0]-self.imgSet_t[im,2]</span>
            <span class="c1">#centers[:,1]=centers[:,1]-self.imgSet_t[im,1]</span>
            <span class="n">centers</span><span class="o">=</span><span class="n">centers</span><span class="o">-</span><span class="n">tSet</span><span class="p">[</span><span class="n">im</span><span class="p">,:]</span>
            <span class="n">cells_x</span><span class="p">[</span><span class="n">indc_img</span><span class="p">,:]</span><span class="o">=</span><span class="n">centers</span>
        <span class="k">if</span> <span class="n">save_h5</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cells_positionSet</span><span class="o">=</span><span class="n">cells_positionSet</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">=</span><span class="n">cells_x</span>
            <span class="n">attribute_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cells_positionSet&#39;</span><span class="p">,</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_to_h5</span><span class="p">(</span><span class="s1">&#39;/cell_data/&#39;</span><span class="p">,</span><span class="n">attribute_list</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cells_x</span></div>

<div class="viewcode-block" id="Trajectory.get_lineage_btrack"><a class="viewcode-back" href="../../source/celltraj.html#celltraj.trajectory.Trajectory.get_lineage_btrack">[docs]</a>    <span class="k">def</span> <span class="nf">get_lineage_btrack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mskchannel</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">distcut</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span><span class="n">framewindow</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span><span class="n">visual_1cell</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">visual</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">max_search_radius</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">save_h5</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">nimg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nt</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;tf_matrix_set&#39;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;need to run get_stack_trans for image stack registration before tracking&#39;</span><span class="p">)</span>
        <span class="n">tf_matrix_set_pad</span><span class="p">,</span><span class="n">pad_dims</span><span class="o">=</span><span class="n">imprep</span><span class="o">.</span><span class="n">get_registration_expansions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tf_matrix_set</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nz</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">)</span>
        <span class="n">segmentation</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nimg</span><span class="p">,</span><span class="o">*</span><span class="n">pad_dims</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nimg</span><span class="p">):</span>
            <span class="n">msk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_mask_data</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmaskchannels</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">msk</span><span class="o">=</span><span class="n">msk</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">mskchannel</span><span class="p">]</span>
            <span class="n">mskT</span><span class="o">=</span><span class="n">imprep</span><span class="o">.</span><span class="n">transform_image</span><span class="p">(</span><span class="n">msk</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">tf_matrix_set</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="o">...</span><span class="p">],</span><span class="n">inverse_tform</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">pad_dims</span><span class="o">=</span><span class="n">pad_dims</span><span class="p">)</span>
            <span class="n">segmentation</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="o">...</span><span class="p">]</span><span class="o">=</span><span class="n">mskT</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;loading and translating mask &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">im</span><span class="p">))</span>
        <span class="n">linSet</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">nimg</span>
        <span class="n">indt0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="o">==</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">linSet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">indt0</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">*-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">iS</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nimg</span><span class="p">):</span>
            <span class="n">fl</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">iS</span><span class="o">-</span><span class="n">framewindow</span><span class="p">)</span>
            <span class="n">fu</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">iS</span><span class="o">+</span><span class="n">framewindow</span><span class="p">,</span><span class="n">nimg</span><span class="p">)</span>
            <span class="n">frameset</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">fl</span><span class="p">,</span><span class="n">fu</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">frameind</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">frameset</span><span class="o">==</span><span class="n">iS</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">masks</span><span class="o">=</span><span class="n">segmentation</span><span class="p">[</span><span class="n">frameset</span><span class="p">,:,:]</span>
            <span class="n">msk</span><span class="o">=</span><span class="n">masks</span><span class="p">[</span><span class="n">frameind</span><span class="p">,:,:]</span>
            <span class="n">msk1</span><span class="o">=</span><span class="n">msk</span>
            <span class="n">msk0</span><span class="o">=</span><span class="n">masks</span><span class="p">[</span><span class="n">frameind</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,:]</span>
            <span class="n">indt1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="o">==</span><span class="n">iS</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">xt1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">indt1</span><span class="p">,:]</span>
            <span class="n">indt0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="o">==</span><span class="n">iS</span><span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">xt0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">indt0</span><span class="p">,:]</span>
            <span class="n">ncells</span><span class="o">=</span><span class="n">xt1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#np.max(masks[frameind,:,:])</span>
            <span class="n">lin1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ncells</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">*-</span><span class="mi">1</span>
            <span class="n">objects</span> <span class="o">=</span> <span class="n">btrack</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">segmentation_to_objects</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;area&#39;</span><span class="p">,</span> <span class="p">))</span> <span class="c1"># initialise a tracker session using a context manager</span>
            <span class="n">tracker</span><span class="o">=</span><span class="n">btrack</span><span class="o">.</span><span class="n">BayesianTracker</span><span class="p">()</span> <span class="c1"># configure the tracker using a config file</span>
            <span class="n">tracker</span><span class="o">.</span><span class="n">configure_from_file</span><span class="p">(</span><span class="s1">&#39;cell_config.json&#39;</span><span class="p">)</span>
            <span class="n">tracker</span><span class="o">.</span><span class="n">update_method</span> <span class="o">=</span> <span class="n">BayesianUpdates</span><span class="o">.</span><span class="n">APPROXIMATE</span>
            <span class="n">tracker</span><span class="o">.</span><span class="n">max_search_radius</span> <span class="o">=</span> <span class="mi">100</span>
            <span class="n">tracker</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span> <span class="c1"># append the objects to be tracked</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">tracker</span><span class="o">.</span><span class="n">volume</span><span class="o">=</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mf">1e5</span><span class="p">,</span> <span class="mf">1e5</span><span class="p">))</span> <span class="c1"># set the volume (Z axis volume is set very large for 2D data)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                <span class="n">tracker</span><span class="o">.</span><span class="n">volume</span><span class="o">=</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nz</span><span class="p">))</span>
            <span class="n">tracker</span><span class="o">.</span><span class="n">track_interactive</span><span class="p">(</span><span class="n">step_size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span> <span class="c1"># track them (in interactive mode)</span>
            <span class="n">tracker</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span> <span class="c1"># generate hypotheses and run the global optimizer</span>
            <span class="n">ntracked</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">itrack</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tracker</span><span class="o">.</span><span class="n">n_tracks</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">frameind</span><span class="p">,</span><span class="n">tracker</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="n">itrack</span><span class="p">][</span><span class="s1">&#39;t&#39;</span><span class="p">]):</span>
                    <span class="n">it</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tracker</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="n">itrack</span><span class="p">][</span><span class="s1">&#39;t&#39;</span><span class="p">])</span><span class="o">==</span><span class="n">frameind</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">tp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tracker</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="n">itrack</span><span class="p">][</span><span class="s1">&#39;t&#39;</span><span class="p">])[</span><span class="n">it</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">tp</span><span class="o">==</span><span class="n">frameind</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">tracker</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="n">itrack</span><span class="p">][</span><span class="s1">&#39;dummy&#39;</span><span class="p">][</span><span class="n">it</span><span class="p">]</span><span class="o">==</span><span class="kc">False</span> <span class="ow">and</span> <span class="n">tracker</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="n">itrack</span><span class="p">][</span><span class="s1">&#39;dummy&#39;</span><span class="p">][</span><span class="n">it</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                            <span class="n">x1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tracker</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="n">itrack</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="n">it</span><span class="p">],</span><span class="n">tracker</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="n">itrack</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="n">it</span><span class="p">]])</span> <span class="c1">#.astype(int)</span>
                            <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tracker</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="n">itrack</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="n">it</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">tracker</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="n">itrack</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="n">it</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span> <span class="c1">#.astype(int)</span>
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                            <span class="n">x1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tracker</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="n">itrack</span><span class="p">][</span><span class="s1">&#39;z&#39;</span><span class="p">][</span><span class="n">it</span><span class="p">],</span><span class="n">tracker</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="n">itrack</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="n">it</span><span class="p">],</span><span class="n">tracker</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="n">itrack</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="n">it</span><span class="p">]])</span> <span class="c1">#.astype(int)</span>
                            <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tracker</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="n">itrack</span><span class="p">][</span><span class="s1">&#39;z&#39;</span><span class="p">][</span><span class="n">it</span><span class="p">],</span><span class="n">tracker</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="n">itrack</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="n">it</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">tracker</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="n">itrack</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="n">it</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span> <span class="c1">#.astype(int)</span>
                        <span class="n">dists_x1</span><span class="o">=</span><span class="n">utilities</span><span class="o">.</span><span class="n">get_dmat</span><span class="p">([</span><span class="n">x1</span><span class="p">],</span><span class="n">xt1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">ind_nnx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">dists_x1</span><span class="p">)</span>
                        <span class="n">ic1</span><span class="o">=</span><span class="n">ind_nnx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">dists_x0</span><span class="o">=</span><span class="n">utilities</span><span class="o">.</span><span class="n">get_dmat</span><span class="p">([</span><span class="n">x0</span><span class="p">],</span><span class="n">xt0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">ind_nnx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">dists_x0</span><span class="p">)</span>
                        <span class="n">ic0</span><span class="o">=</span><span class="n">ind_nnx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">dists_x1</span><span class="p">[</span><span class="n">ic1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">distcut</span> <span class="ow">and</span> <span class="n">dists_x0</span><span class="p">[</span><span class="n">ic0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">distcut</span><span class="p">:</span>
                            <span class="n">lin1</span><span class="p">[</span><span class="n">ic1</span><span class="p">]</span><span class="o">=</span><span class="n">ic0</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;frame </span><span class="si">{</span><span class="n">iS</span><span class="si">}</span><span class="s1"> a real track cell </span><span class="si">{</span><span class="n">ic0</span><span class="si">}</span><span class="s1"> to cell </span><span class="si">{</span><span class="n">ic1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="n">ntracked</span><span class="o">=</span><span class="n">ntracked</span><span class="o">+</span><span class="mi">1</span>
                        <span class="k">if</span> <span class="n">visual_1cell</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                                <span class="n">vmsk1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">msk1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                                <span class="n">vmsk0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">msk0</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                                <span class="n">ix</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">iy</span><span class="o">=</span><span class="mi">2</span>
                            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                                <span class="n">vmsk1</span><span class="o">=</span><span class="n">msk1</span>
                                <span class="n">vmsk0</span><span class="o">=</span><span class="n">msk0</span>
                                <span class="n">ix</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">iy</span><span class="o">=</span><span class="mi">1</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x1</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span><span class="n">x1</span><span class="p">[</span><span class="n">iy</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x0</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span><span class="n">x0</span><span class="p">[</span><span class="n">iy</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xt1</span><span class="p">[:,</span><span class="n">ix</span><span class="p">],</span><span class="n">xt1</span><span class="p">[:,</span><span class="n">iy</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkred&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xt0</span><span class="p">[:,</span><span class="n">ix</span><span class="p">],</span><span class="n">xt0</span><span class="p">[:,</span><span class="n">iy</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgreen&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xt1</span><span class="p">[</span><span class="n">ic1</span><span class="p">,</span><span class="n">ix</span><span class="p">],</span><span class="n">xt1</span><span class="p">[</span><span class="n">ic1</span><span class="p">,</span><span class="n">iy</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkred&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xt0</span><span class="p">[</span><span class="n">ic0</span><span class="p">,</span><span class="n">ix</span><span class="p">],</span><span class="n">xt0</span><span class="p">[</span><span class="n">ic0</span><span class="p">,</span><span class="n">iy</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgreen&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">vmsk1</span><span class="o">.</span><span class="n">T</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">.3</span><span class="p">)</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">vmsk0</span><span class="o">.</span><span class="n">T</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">.3</span><span class="p">)</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">visual</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                    <span class="n">vmsk1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">msk1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">vmsk0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">msk0</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">ix</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">iy</span><span class="o">=</span><span class="mi">2</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                    <span class="n">vmsk1</span><span class="o">=</span><span class="n">msk1</span>
                    <span class="n">vmsk0</span><span class="o">=</span><span class="n">msk0</span>
                    <span class="n">ix</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">iy</span><span class="o">=</span><span class="mi">1</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xt1</span><span class="p">[:,</span><span class="n">ix</span><span class="p">],</span><span class="n">xt1</span><span class="p">[:,</span><span class="n">iy</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkred&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xt0</span><span class="p">[:,</span><span class="n">ix</span><span class="p">],</span><span class="n">xt0</span><span class="p">[:,</span><span class="n">iy</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgreen&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">vmsk1</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vmsk1</span><span class="p">)),</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">.3</span><span class="p">,</span><span class="n">linewidths</span><span class="o">=</span><span class="mf">.3</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">vmsk0</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vmsk0</span><span class="p">)),</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">.3</span><span class="p">,</span><span class="n">linewidths</span><span class="o">=</span><span class="mf">.3</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xt1</span><span class="p">[</span><span class="n">lin1</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">,</span><span class="n">ix</span><span class="p">],</span><span class="n">xt1</span><span class="p">[</span><span class="n">lin1</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">,</span><span class="n">iy</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">.1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;frame &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">iS</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; tracked &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ntracked</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; of &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ncells</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; cells&#39;</span><span class="p">)</span>
            <span class="n">linSet</span><span class="p">[</span><span class="n">iS</span><span class="p">]</span><span class="o">=</span><span class="n">lin1</span>
        <span class="k">if</span> <span class="n">save_h5</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">linSet</span><span class="o">=</span><span class="n">linSet</span>
            <span class="n">attribute_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;linSet&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_to_h5</span><span class="p">(</span><span class="s1">&#39;/cell_data/&#39;</span><span class="p">,</span><span class="n">attribute_list</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">linSet</span></div>

<div class="viewcode-block" id="Trajectory.get_lineage_mindist"><a class="viewcode-back" href="../../source/celltraj.html#celltraj.trajectory.Trajectory.get_lineage_mindist">[docs]</a>    <span class="k">def</span> <span class="nf">get_lineage_mindist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">distcut</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span><span class="n">visual</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">save_h5</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">nimg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nt</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;x&#39;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;need to run get_cell_positions for cell locations&#39;</span><span class="p">)</span>
        <span class="n">linSet</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">nimg</span>
        <span class="n">indt0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="o">==</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">linSet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">indt0</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">*-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">iS</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nimg</span><span class="p">):</span>
            <span class="n">indt1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="o">==</span><span class="n">iS</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">xt1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">indt1</span><span class="p">,:]</span>
            <span class="n">indt0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="o">==</span><span class="n">iS</span><span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">xt0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">indt0</span><span class="p">,:]</span>
            <span class="n">ncells</span><span class="o">=</span><span class="n">xt1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#np.max(masks[frameind,:,:])</span>
            <span class="n">lin1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ncells</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">*-</span><span class="mi">1</span>
            <span class="n">ntracked</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">dmatx</span><span class="o">=</span><span class="n">utilities</span><span class="o">.</span><span class="n">get_dmat</span><span class="p">(</span><span class="n">xt1</span><span class="p">,</span><span class="n">xt0</span><span class="p">)</span>
            <span class="n">lin1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">indt1</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">indt1</span><span class="o">.</span><span class="n">size</span><span class="p">):</span> <span class="c1">#nn tracking</span>
                <span class="n">ind_nnx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">dmatx</span><span class="p">[</span><span class="n">ic</span><span class="p">,:])</span>
                <span class="n">cdist</span><span class="o">=</span><span class="n">utilities</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">xt0</span><span class="p">[</span><span class="n">ind_nnx</span><span class="p">[</span><span class="mi">0</span><span class="p">],:],</span><span class="n">xt1</span><span class="p">[</span><span class="n">ic</span><span class="p">,:])</span>
                <span class="k">if</span> <span class="n">cdist</span><span class="o">&lt;</span><span class="n">distcut</span><span class="p">:</span>
                    <span class="n">lin1</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">=</span><span class="n">ind_nnx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">lin1</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">=-</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">visual</span><span class="p">:</span>
                <span class="n">msk1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_mask_data</span><span class="p">(</span><span class="n">iS</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">mskchannel</span><span class="p">]</span>
                <span class="n">msk0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_mask_data</span><span class="p">(</span><span class="n">iS</span><span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">mskchannel</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                    <span class="n">vmsk1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">msk1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">vmsk0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">msk0</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">ix</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">iy</span><span class="o">=</span><span class="mi">2</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                    <span class="n">vmsk1</span><span class="o">=</span><span class="n">msk1</span>
                    <span class="n">vmsk0</span><span class="o">=</span><span class="n">msk0</span>
                    <span class="n">ix</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">iy</span><span class="o">=</span><span class="mi">1</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xt1</span><span class="p">[:,</span><span class="n">ix</span><span class="p">],</span><span class="n">xt1</span><span class="p">[:,</span><span class="n">iy</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkred&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xt0</span><span class="p">[:,</span><span class="n">ix</span><span class="p">],</span><span class="n">xt0</span><span class="p">[:,</span><span class="n">iy</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgreen&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">vmsk1</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vmsk1</span><span class="p">)),</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">.3</span><span class="p">,</span><span class="n">linewidths</span><span class="o">=</span><span class="mf">.3</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">vmsk0</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vmsk0</span><span class="p">)),</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">.3</span><span class="p">,</span><span class="n">linewidths</span><span class="o">=</span><span class="mf">.3</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xt1</span><span class="p">[</span><span class="n">lin1</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">,</span><span class="n">ix</span><span class="p">],</span><span class="n">xt1</span><span class="p">[</span><span class="n">lin1</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">,</span><span class="n">iy</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">.1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;frame &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">iS</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; tracked &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ntracked</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; of &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ncells</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; cells&#39;</span><span class="p">)</span>
            <span class="n">linSet</span><span class="p">[</span><span class="n">iS</span><span class="p">]</span><span class="o">=</span><span class="n">lin1</span>
        <span class="k">if</span> <span class="n">save_h5</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">linSet</span><span class="o">=</span><span class="n">linSet</span>
            <span class="n">attribute_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;linSet&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_to_h5</span><span class="p">(</span><span class="s1">&#39;/cell_data/&#39;</span><span class="p">,</span><span class="n">attribute_list</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">linSet</span></div>

<div class="viewcode-block" id="Trajectory.get_cell_trajectory"><a class="viewcode-back" href="../../source/celltraj.html#celltraj.trajectory.Trajectory.get_cell_trajectory">[docs]</a>    <span class="k">def</span> <span class="nf">get_cell_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cell_ind</span><span class="p">,</span><span class="n">n_hist</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span> <span class="c1">#cell trajectory stepping backwards</span>
        <span class="n">minframe</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_hist</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">n_hist</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">cell_ind</span><span class="p">]</span><span class="o">-</span><span class="n">minframe</span><span class="p">)</span>
        <span class="n">cell_ind_history</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n_hist</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">cell_ind_history</span><span class="p">[:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">cell_ind_history</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">cell_ind</span>
        <span class="n">ended</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">iH</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n_hist</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">indCurrentCell</span><span class="o">=</span><span class="n">cell_ind_history</span><span class="p">[</span><span class="n">iH</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ended</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">indCurrentCell</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">indCurrentCell</span><span class="p">)</span>
                <span class="n">iframe1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">indCurrentCell</span><span class="p">]</span>
                <span class="n">iframe0</span><span class="o">=</span><span class="n">iframe1</span><span class="o">-</span><span class="mi">1</span>
                <span class="k">if</span> <span class="n">indCurrentCell</span><span class="o">&lt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ended</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;cell &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">indCurrentCell</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; ended last frame: History must end NOW!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">cell_ind_history</span><span class="p">[</span><span class="n">iH</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">ended</span><span class="o">=</span><span class="kc">True</span>
                <span class="k">elif</span> <span class="n">indCurrentCell</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ended</span><span class="p">:</span>
                    <span class="n">indt1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_frameSet</span><span class="o">==</span><span class="n">iframe1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">i1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">indt1</span><span class="o">==</span><span class="n">indCurrentCell</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">indt0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_frameSet</span><span class="o">==</span><span class="n">iframe0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">indtrack</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">linSet</span><span class="p">[</span><span class="n">iframe1</span><span class="p">][</span><span class="n">i1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">indtrack</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="c1">#sys.stdout.write(&#39;            cell &#39;+str(indCurrentCell)+&#39; ended &#39;+str(iH)+&#39; frames ago\n&#39;)</span>
                        <span class="n">cell_ind_history</span><span class="p">[</span><span class="n">iH</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                        <span class="n">ended</span><span class="o">=</span><span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cell_ind_history</span><span class="p">[</span><span class="n">iH</span><span class="p">]</span><span class="o">=</span><span class="n">indt0</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">linSet</span><span class="p">[</span><span class="n">iframe1</span><span class="p">][</span><span class="n">i1</span><span class="p">]]</span>
        <span class="n">indtracked</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cell_ind_history</span><span class="p">)))</span>
        <span class="n">cell_traj</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">cell_ind_history</span><span class="p">[</span><span class="n">indtracked</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">cell_traj</span></div>

<div class="viewcode-block" id="Trajectory.get_unique_trajectories"><a class="viewcode-back" href="../../source/celltraj.html#celltraj.trajectory.Trajectory.get_unique_trajectories">[docs]</a>    <span class="k">def</span> <span class="nf">get_unique_trajectories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cell_inds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">extra_depth</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">extra_depth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;trajl&#39;</span><span class="p">):</span>
                <span class="n">extra_depth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trajl</span><span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">extra_depth</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">if</span> <span class="n">cell_inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cell_inds_all</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indSet</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cell_inds_all</span><span class="o">=</span><span class="n">cell_inds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">n_untracked</span><span class="o">=</span><span class="n">cell_inds_all</span><span class="o">.</span><span class="n">size</span>
        <span class="n">trajectories</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">inds_tracked</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">n_untracked</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">indc</span><span class="o">=</span><span class="n">cell_inds_all</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">cell_traj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cell_trajectory</span><span class="p">(</span><span class="n">indc</span><span class="p">)</span>
            <span class="n">indctracked</span><span class="p">,</span><span class="n">indcomm_tracked</span><span class="p">,</span><span class="n">indcomm_traj</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">inds_tracked</span><span class="p">,</span><span class="n">cell_traj</span><span class="p">,</span><span class="n">return_indices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">indctracked</span><span class="o">.</span><span class="n">size</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">indcomm_last</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">indcomm_traj</span><span class="p">)</span>
                <span class="c1">#sys.stdout.write(&#39;cell &#39;+str(indc)+&#39; tracks to &#39;+str(cell_traj[indcomm_last])+&#39;, already tracked\n&#39;)</span>
                <span class="k">if</span> <span class="n">indcomm_last</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">extra_depth</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">indlast</span><span class="o">=</span><span class="n">indcomm_last</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">extra_depth</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">indlast</span><span class="o">=</span><span class="mi">0</span>
                <span class="n">cell_traj</span><span class="o">=</span><span class="n">cell_traj</span><span class="p">[</span><span class="n">indlast</span><span class="p">:]</span> <span class="c1">#retain only unique tracks up to extra_depth from common point</span>
            <span class="n">inds_tracked</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inds_tracked</span><span class="p">,</span><span class="n">cell_traj</span><span class="p">)</span>
            <span class="n">trajectories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell_traj</span><span class="p">)</span>
            <span class="n">indcells</span><span class="p">,</span><span class="n">indcomm_call</span><span class="p">,</span><span class="n">indcomm_ctraj</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">cell_inds_all</span><span class="p">,</span><span class="n">cell_traj</span><span class="p">,</span><span class="n">return_indices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">cell_inds_all</span><span class="p">[</span><span class="n">indcomm_call</span><span class="p">]</span><span class="o">=-</span><span class="mi">1</span>
            <span class="n">inds_untracked</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cell_inds_all</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">cell_inds_all</span><span class="o">=</span><span class="n">cell_inds_all</span><span class="p">[</span><span class="n">inds_untracked</span><span class="p">]</span>
            <span class="n">n_untracked</span><span class="o">=</span><span class="n">cell_inds_all</span><span class="o">.</span><span class="n">size</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;tracked cell &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">indc</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;, &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">cell_traj</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; tracks, &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">n_untracked</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; left</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">n_untracked</span><span class="o">%</span><span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;tracked cell &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">indc</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;, &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">cell_traj</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; tracks, &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">n_untracked</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; left</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trajectories</span><span class="o">=</span><span class="n">trajectories</span></div>

<div class="viewcode-block" id="Trajectory.get_traj_segments"><a class="viewcode-back" href="../../source/celltraj.html#celltraj.trajectory.Trajectory.get_traj_segments">[docs]</a>    <span class="k">def</span> <span class="nf">get_traj_segments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">seg_length</span><span class="p">):</span>
        <span class="n">ntraj</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajectories</span><span class="p">)</span>
        <span class="n">traj_segSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="n">seg_length</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">itraj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntraj</span><span class="p">):</span>
            <span class="n">cell_traj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trajectories</span><span class="p">[</span><span class="n">itraj</span><span class="p">]</span>
            <span class="n">traj_len</span><span class="o">=</span><span class="n">cell_traj</span><span class="o">.</span><span class="n">size</span>
            <span class="k">if</span> <span class="n">traj_len</span><span class="o">&gt;=</span><span class="n">seg_length</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">traj_len</span><span class="o">-</span><span class="n">seg_length</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span> <span class="c1">#was -1, think that was an error, changed 2june21 because ended up missing data</span>
                    <span class="n">traj_seg</span><span class="o">=</span><span class="n">cell_traj</span><span class="p">[</span><span class="n">ic</span><span class="p">:</span><span class="n">ic</span><span class="o">+</span><span class="n">seg_length</span><span class="p">]</span>
                    <span class="n">traj_segSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">traj_segSet</span><span class="p">,</span><span class="n">traj_seg</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">traj_segSet</span></div>

<div class="viewcode-block" id="Trajectory.get_Xtraj_celltrajectory"><a class="viewcode-back" href="../../source/celltraj.html#celltraj.trajectory.Trajectory.get_Xtraj_celltrajectory">[docs]</a>    <span class="k">def</span> <span class="nf">get_Xtraj_celltrajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cell_traj</span><span class="p">,</span><span class="n">Xtraj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">traj</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1">#traj and</span>
        <span class="k">if</span> <span class="n">traj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">traj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">traj</span>
        <span class="k">if</span> <span class="n">Xtraj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Xtraj</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span><span class="o">=</span><span class="n">Xtraj</span>
        <span class="n">ntraj</span><span class="o">=</span><span class="n">cell_traj</span><span class="o">.</span><span class="n">size</span>
        <span class="n">neigen</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">xt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="n">neigen</span><span class="p">))</span>
        <span class="n">inds_traj</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">itraj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntraj</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">trajl</span><span class="p">):</span>
            <span class="n">test</span><span class="o">=</span><span class="n">cell_traj</span><span class="p">[</span><span class="n">itraj</span><span class="p">:</span><span class="n">itraj</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">trajl</span><span class="p">]</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">traj</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">==</span> <span class="n">test</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:])</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">indt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">res</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">xt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xt</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="n">indt</span><span class="p">,:]]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">inds_traj</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inds_traj</span><span class="p">,</span><span class="n">indt</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">xt</span><span class="p">,</span><span class="n">inds_traj</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span></div>

<div class="viewcode-block" id="Trajectory.get_trajectory_steps"><a class="viewcode-back" href="../../source/celltraj.html#celltraj.trajectory.Trajectory.get_trajectory_steps">[docs]</a>    <span class="k">def</span> <span class="nf">get_trajectory_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">inds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">traj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">Xtraj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">get_trajectories</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">nlag</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span> <span class="c1">#traj and Xtraj should be indexed same</span>
        <span class="k">if</span> <span class="n">inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indSet</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">get_trajectories</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_unique_trajectories</span><span class="p">(</span><span class="n">cell_inds</span><span class="o">=</span><span class="n">inds</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">traj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">traj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">traj</span>
        <span class="k">if</span> <span class="n">Xtraj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Xtraj</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span><span class="o">=</span><span class="n">Xtraj</span>
        <span class="n">trajp1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_traj_segments</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajl</span><span class="o">+</span><span class="n">nlag</span><span class="p">)</span>
        <span class="n">inds_nlag</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajl</span><span class="o">+</span><span class="n">nlag</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="n">nlag</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1">#keep indices every nlag</span>
        <span class="n">trajp1</span><span class="o">=</span><span class="n">trajp1</span><span class="p">[:,</span><span class="n">inds_nlag</span><span class="p">]</span>
        <span class="n">ntraj</span><span class="o">=</span><span class="n">trajp1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">neigen</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="n">neigen</span><span class="p">))</span>
        <span class="n">x1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="n">neigen</span><span class="p">))</span>
        <span class="n">inds_trajp1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">itraj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntraj</span><span class="p">):</span>
            <span class="n">test0</span><span class="o">=</span><span class="n">trajp1</span><span class="p">[</span><span class="n">itraj</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">test1</span><span class="o">=</span><span class="n">trajp1</span><span class="p">[</span><span class="n">itraj</span><span class="p">,</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">res0</span> <span class="o">=</span> <span class="p">(</span><span class="n">traj</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">==</span> <span class="n">test0</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:])</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">res1</span> <span class="o">=</span> <span class="p">(</span><span class="n">traj</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">==</span> <span class="n">test1</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:])</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">res0</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">res1</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">indt0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">res0</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">indt1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">res1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="n">indt0</span><span class="p">,:]]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">x1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="n">indt1</span><span class="p">,:]]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">inds_trajp1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inds_trajp1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">indt0</span><span class="p">,</span><span class="n">indt1</span><span class="p">]]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">itraj</span><span class="o">%</span><span class="mi">100</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;matching up trajectory &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">itraj</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Xtraj0</span><span class="o">=</span><span class="n">x0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Xtraj1</span><span class="o">=</span><span class="n">x1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inds_trajp1</span><span class="o">=</span><span class="n">inds_trajp1</span></div>

<div class="viewcode-block" id="Trajectory.get_trajAB_segments"><a class="viewcode-back" href="../../source/celltraj.html#celltraj.trajectory.Trajectory.get_trajAB_segments">[docs]</a>    <span class="k">def</span> <span class="nf">get_trajAB_segments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">xt</span><span class="p">,</span><span class="n">stateA</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">stateB</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">clusters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">states</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">distcutA</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">distcutB</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Takes real or assigned trajectories as input and returns indices in A (only stateA defined), or between A and B (stateA and stateB defined).</span>
<span class="sd">        A is 1, B is 2, not A or B is 0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nt</span><span class="o">=</span><span class="n">xt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">inds_xt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nt</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">xt</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">typecodes</span><span class="p">[</span><span class="s1">&#39;AllInteger&#39;</span><span class="p">]:</span>
            <span class="n">is_statetraj</span><span class="o">=</span><span class="kc">True</span>
            <span class="n">states_xt</span><span class="o">=</span><span class="n">xt</span>
            <span class="k">if</span> <span class="n">clusters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;discretized trajectory provided, ignoring provided clusters...&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">states</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;warning: discretized trajectories passed through provided states, probably unintended&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">is_statetraj</span><span class="o">=</span><span class="kc">False</span>
        <span class="k">if</span> <span class="n">stateA</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Must provide at least one state&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">stateB</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">is_1state</span><span class="o">=</span><span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">is_1state</span><span class="o">=</span><span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_statetraj</span> <span class="ow">and</span> <span class="n">clusters</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">distcutA</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;must provide a clustering for continuous trajectories&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_statetraj</span> <span class="ow">and</span> <span class="n">clusters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">states_xt</span><span class="o">=</span><span class="n">clusters</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">xt</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_statetraj</span> <span class="ow">and</span> <span class="n">distcutA</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">stateA</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">typecodes</span><span class="p">[</span><span class="s1">&#39;AllFloat&#39;</span><span class="p">]:</span>
                <span class="n">distsA</span><span class="o">=</span><span class="n">utilities</span><span class="o">.</span><span class="n">get_dmat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">stateA</span><span class="p">]),</span><span class="n">xt</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">states_xt</span><span class="o">=</span><span class="n">distsA</span><span class="o">&lt;</span><span class="n">distcutA</span>
                <span class="n">states_xt</span><span class="o">=</span><span class="n">states_xt</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">stateA</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_1state</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">distcutB</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;must provide a distance cutoff for both states for continuous trajectories&#39;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">None</span>
                    <span class="n">distsB</span><span class="o">=</span><span class="n">utilities</span><span class="o">.</span><span class="n">get_dmat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">stateB</span><span class="p">]),</span><span class="n">xt</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">states_xt</span><span class="p">[</span><span class="n">distsB</span><span class="o">&lt;</span><span class="n">distcutB</span><span class="p">]</span><span class="o">=</span><span class="mi">2</span>
                    <span class="n">stateB</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">states</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">states</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">states_xt</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">states_xt</span><span class="o">=</span><span class="n">states</span><span class="p">[</span><span class="n">states_xt</span><span class="p">]</span>
        <span class="n">states_xtA</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">states_xt</span><span class="p">,</span><span class="n">stateA</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_1state</span><span class="p">:</span>
            <span class="n">inds_xt</span><span class="p">[</span><span class="n">states_xtA</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
            <span class="n">slices</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">clump_masked</span><span class="p">(</span><span class="n">inds_xt</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">slices</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_1state</span><span class="p">:</span>
            <span class="n">states_xtB</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">states_xt</span><span class="p">,</span><span class="n">stateB</span><span class="p">)</span>
            <span class="n">fromA</span><span class="o">=</span><span class="kc">False</span>
            <span class="n">fromB</span><span class="o">=</span><span class="kc">False</span>
            <span class="n">lastinA</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">states_xt</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
            <span class="n">nextinB</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">states_xt</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">itt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">fromA</span> <span class="ow">and</span> <span class="n">states_xtA</span><span class="p">[</span><span class="n">itt</span><span class="p">]:</span>
                    <span class="n">fromA</span><span class="o">=</span><span class="kc">True</span>
                <span class="k">if</span> <span class="n">fromA</span> <span class="ow">and</span> <span class="n">states_xtB</span><span class="p">[</span><span class="n">itt</span><span class="p">]:</span>
                    <span class="n">fromA</span><span class="o">=</span><span class="kc">False</span>
                <span class="n">lastinA</span><span class="p">[</span><span class="n">itt</span><span class="p">]</span><span class="o">=</span><span class="n">fromA</span>
            <span class="k">for</span> <span class="n">itt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">fromB</span> <span class="ow">and</span> <span class="n">states_xtB</span><span class="p">[</span><span class="n">itt</span><span class="p">]:</span>
                    <span class="n">fromB</span><span class="o">=</span><span class="kc">True</span>
                <span class="k">if</span> <span class="n">fromB</span> <span class="ow">and</span> <span class="n">states_xtA</span><span class="p">[</span><span class="n">itt</span><span class="p">]:</span>
                    <span class="n">fromB</span><span class="o">=</span><span class="kc">False</span>
                <span class="n">nextinB</span><span class="p">[</span><span class="n">itt</span><span class="p">]</span><span class="o">=</span><span class="n">fromB</span>
            <span class="n">lastinA_goestoB</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">lastinA</span><span class="p">,</span><span class="n">nextinB</span><span class="p">)</span>
            <span class="n">indsAB</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">lastinA</span><span class="p">,</span><span class="n">nextinB</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">indAB</span> <span class="ow">in</span> <span class="n">indsAB</span><span class="p">:</span>
                <span class="n">lastinA_goestoB</span><span class="p">[</span><span class="n">indAB</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="kc">True</span>
                <span class="n">lastinA_goestoB</span><span class="p">[</span><span class="n">indAB</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="kc">True</span>
            <span class="n">inds_xt</span><span class="p">[</span><span class="n">lastinA_goestoB</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
            <span class="n">slices</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">clump_masked</span><span class="p">(</span><span class="n">inds_xt</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">slices</span></div>

<div class="viewcode-block" id="Trajectory.get_pair_rdf"><a class="viewcode-back" href="../../source/celltraj.html#celltraj.trajectory.Trajectory.get_pair_rdf">[docs]</a>    <span class="k">def</span> <span class="nf">get_pair_rdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cell_indsA</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">cell_indsB</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rbins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nr</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">rmax</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cell_indsA</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cell_indsA</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indSet</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cell_indsB</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cell_indsB</span><span class="o">=</span><span class="n">cell_indsA</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rbins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rbins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.e-6</span><span class="p">,</span><span class="n">rmax</span><span class="p">,</span><span class="n">nr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rbins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">rbins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">rbins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">1.e-8</span>
        <span class="n">nr</span><span class="o">=</span><span class="n">rbins</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">paircorrx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nr</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">indimgsA</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">cell_indsA</span><span class="p">])</span>
        <span class="n">indimgsB</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">cell_indsB</span><span class="p">])</span>
        <span class="n">indimgs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">indimgsA</span><span class="p">,</span><span class="n">indimgsB</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">indimgs</span><span class="p">:</span>
            <span class="n">cell_inds_imgA</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">cell_indsA</span><span class="p">]</span><span class="o">==</span><span class="n">im</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cell_inds_imgB</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">cell_indsB</span><span class="p">]</span><span class="o">==</span><span class="n">im</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">xSetA</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">cell_indsA</span><span class="p">[</span><span class="n">cell_inds_imgA</span><span class="p">],:]</span>
            <span class="n">xSetB</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">cell_indsB</span><span class="p">[</span><span class="n">cell_inds_imgB</span><span class="p">],:]</span>
            <span class="n">dmatr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_dmat</span><span class="p">(</span><span class="n">xSetA</span><span class="p">,</span><span class="n">xSetB</span><span class="p">)</span>
            <span class="n">indr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">dmatr</span><span class="p">,</span><span class="n">rbins</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ir</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nr</span><span class="p">):</span>
                <span class="n">paircorrx</span><span class="p">[</span><span class="n">ir</span><span class="p">]</span><span class="o">=</span><span class="n">paircorrx</span><span class="p">[</span><span class="n">ir</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">indr</span><span class="o">==</span><span class="n">ir</span><span class="p">)</span>
        <span class="n">drbins</span><span class="o">=</span><span class="n">rbins</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">rbins</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">rbins</span><span class="o">=</span><span class="n">rbins</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">paircorrx</span><span class="o">=</span><span class="n">paircorrx</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">V</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="n">nc</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">ir</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">norm</span><span class="o">=</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">rbins</span><span class="p">[</span><span class="n">ir</span><span class="p">]</span><span class="o">*</span><span class="n">drbins</span><span class="p">[</span><span class="n">ir</span><span class="p">]</span>
            <span class="n">V</span><span class="o">=</span><span class="n">V</span><span class="o">+</span><span class="n">norm</span>
            <span class="n">nc</span><span class="o">=</span><span class="n">nc</span><span class="o">+</span><span class="n">paircorrx</span><span class="p">[</span><span class="n">ir</span><span class="p">]</span>
            <span class="n">paircorrx</span><span class="p">[</span><span class="n">ir</span><span class="p">]</span><span class="o">=</span><span class="n">paircorrx</span><span class="p">[</span><span class="n">ir</span><span class="p">]</span><span class="o">/</span><span class="n">norm</span>
        <span class="n">paircorrx</span><span class="o">=</span><span class="n">paircorrx</span><span class="o">*</span><span class="n">V</span><span class="o">/</span><span class="n">nc</span>
        <span class="k">return</span> <span class="n">rbins</span><span class="p">,</span><span class="n">paircorrx</span></div>

<div class="viewcode-block" id="Trajectory.get_cell_neighborhood"><a class="viewcode-back" href="../../source/celltraj.html#celltraj.trajectory.Trajectory.get_cell_neighborhood">[docs]</a>    <span class="k">def</span> <span class="nf">get_cell_neighborhood</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">indcell</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">indcells</span><span class="p">,</span><span class="n">intersurfaces</span></div>

<div class="viewcode-block" id="Trajectory.get_alpha"><a class="viewcode-back" href="../../source/celltraj.html#celltraj.trajectory.Trajectory.get_alpha">[docs]</a>    <span class="k">def</span> <span class="nf">get_alpha</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">i1</span><span class="p">,</span><span class="n">i2</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ip1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cell_trajectory</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span><span class="n">n_hist</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">ip2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cell_trajectory</span><span class="p">(</span><span class="n">i2</span><span class="p">,</span><span class="n">n_hist</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">dx1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i1</span><span class="p">,:]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ip1</span><span class="p">,:]</span>
            <span class="n">dx1</span><span class="o">=</span><span class="n">dx1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dx1</span><span class="p">)</span>
            <span class="n">dx2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i2</span><span class="p">,:]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ip2</span><span class="p">,:]</span>
            <span class="n">dx2</span><span class="o">=</span><span class="n">dx2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dx2</span><span class="p">)</span>
            <span class="n">pij</span><span class="o">=</span><span class="n">dx1</span><span class="o">-</span><span class="n">dx2</span>
            <span class="n">rij</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i1</span><span class="p">,:]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i2</span><span class="p">,:])</span>
            <span class="n">nij</span><span class="o">=</span><span class="n">rij</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">rij</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">pij</span><span class="p">,</span><span class="n">nij</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">return</span> <span class="n">alpha</span></div>

<div class="viewcode-block" id="Trajectory.get_beta"><a class="viewcode-back" href="../../source/celltraj.html#celltraj.trajectory.Trajectory.get_beta">[docs]</a>    <span class="k">def</span> <span class="nf">get_beta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">i1</span><span class="p">,</span><span class="n">i2</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ip1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cell_trajectory</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span><span class="n">n_hist</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">ip2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cell_trajectory</span><span class="p">(</span><span class="n">i2</span><span class="p">,</span><span class="n">n_hist</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">dx1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i1</span><span class="p">,:]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ip1</span><span class="p">,:]</span>
            <span class="n">dx1</span><span class="o">=</span><span class="n">dx1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dx1</span><span class="p">)</span>
            <span class="n">dx2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i2</span><span class="p">,:]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ip2</span><span class="p">,:]</span>
            <span class="n">dx2</span><span class="o">=</span><span class="n">dx2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dx2</span><span class="p">)</span>
            <span class="n">beta</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">dx1</span><span class="p">,</span><span class="n">dx2</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">beta</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">return</span> <span class="n">beta</span></div>

<div class="viewcode-block" id="Trajectory.get_dx"><a class="viewcode-back" href="../../source/celltraj.html#celltraj.trajectory.Trajectory.get_dx">[docs]</a>    <span class="k">def</span> <span class="nf">get_dx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">i1</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ip1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cell_trajectory</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span><span class="n">n_hist</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">dx1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i1</span><span class="p">,:]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ip1</span><span class="p">,:]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">dx1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">return</span> <span class="n">dx1</span></div>

<div class="viewcode-block" id="Trajectory.feat_comdx"><a class="viewcode-back" href="../../source/celltraj.html#celltraj.trajectory.Trajectory.feat_comdx">[docs]</a>    <span class="k">def</span> <span class="nf">feat_comdx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">indcell</span><span class="p">,</span><span class="n">bmsk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">bunch_clusters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cell_trajectory</span><span class="p">(</span><span class="n">indcell</span><span class="p">,</span><span class="n">n_hist</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">indcells</span><span class="p">,</span><span class="n">intersurfaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cell_neighborhood</span><span class="p">(</span><span class="n">indcell</span><span class="p">,</span><span class="n">bmsk</span><span class="o">=</span><span class="n">bmsk</span><span class="p">,</span><span class="n">bunch_clusters</span><span class="o">=</span><span class="n">bunch_clusters</span><span class="p">)</span>
            <span class="n">alphaSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">indcells</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="n">betaSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">indcells</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">indcells</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                <span class="n">alphaSet</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_alpha</span><span class="p">(</span><span class="n">indcell</span><span class="p">,</span><span class="n">indcells</span><span class="p">[</span><span class="n">ic</span><span class="p">])</span>
                <span class="n">betaSet</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_beta</span><span class="p">(</span><span class="n">indcell</span><span class="p">,</span><span class="n">indcells</span><span class="p">[</span><span class="n">ic</span><span class="p">])</span>
            <span class="n">intersurfaces</span><span class="o">=</span><span class="n">intersurfaces</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">intersurfaces</span><span class="p">)</span>
            <span class="n">comdx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">comdx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_dx</span><span class="p">(</span><span class="n">indcell</span><span class="p">))</span>
            <span class="n">comdx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">intersurfaces</span><span class="p">,</span><span class="n">alphaSet</span><span class="p">))</span>
            <span class="n">comdx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">intersurfaces</span><span class="p">,</span><span class="n">betaSet</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">comdx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">return</span> <span class="n">comdx</span></div>

<div class="viewcode-block" id="Trajectory.get_comdx_features"><a class="viewcode-back" href="../../source/celltraj.html#celltraj.trajectory.Trajectory.get_comdx_features">[docs]</a>    <span class="k">def</span> <span class="nf">get_comdx_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cell_inds</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">nfeat_com</span><span class="o">=</span><span class="mi">3</span>
        <span class="k">if</span> <span class="n">cell_inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cell_inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">Xf_com</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">nfeat_com</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">traj_pairSet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_traj_segments</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">indimgs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">cell_inds</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">indimgs</span><span class="p">:</span>
            <span class="n">fmsk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fmskSet</span><span class="p">[</span><span class="n">im</span><span class="p">,:,:]</span>
            <span class="n">bmsk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cell_bunches</span><span class="p">(</span><span class="n">fmsk</span><span class="p">,</span><span class="n">bunchcut</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="n">bunch_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_bunch_clusters</span><span class="p">(</span><span class="n">bmsk</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[</span><span class="n">im</span><span class="p">,:])</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;extracting motility features from image &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">im</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; of &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">indimgs</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">cell_inds_img</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">cell_inds</span><span class="p">]</span><span class="o">==</span><span class="n">im</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">indcells</span><span class="p">,</span><span class="n">indcomm_cindimg</span><span class="p">,</span><span class="n">indcomm_ctraj</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">cell_inds</span><span class="p">[</span><span class="n">cell_inds_img</span><span class="p">],</span><span class="n">traj_pairSet</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">return_indices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">xSet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">traj_pairSet</span><span class="p">[</span><span class="n">indcomm_ctraj</span><span class="p">,</span><span class="mi">1</span><span class="p">],:]</span>
            <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="n">indcomm_ctraj</span><span class="p">:</span>
                <span class="n">indcell</span><span class="o">=</span><span class="n">traj_pairSet</span><span class="p">[</span><span class="n">ic</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">comdx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feat_comdx</span><span class="p">(</span><span class="n">indcell</span><span class="p">,</span><span class="n">bmsk</span><span class="o">=</span><span class="n">bmsk</span><span class="p">,</span><span class="n">bunch_clusters</span><span class="o">=</span><span class="n">bunch_clusters</span><span class="p">)</span>
                <span class="n">Xf_com</span><span class="p">[</span><span class="n">indcell</span><span class="p">,:]</span><span class="o">=</span><span class="n">comdx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Xf_com</span><span class="o">=</span><span class="n">Xf_com</span></div></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Jeremy Copperman.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>